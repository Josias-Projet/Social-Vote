<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>R√®glement - Social Vote</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   <link rel="icon" type="image/png" href="/assets/images/favicon.png">
   <link rel="manifest" href="../manifest.json">
    <style>
    :root{
      --primary:#0A1F44;--accent:#D4AF37;--white:#fff;--light-bg:#F8F9FA;
      --gray:#6C757D;--dark:#343A40;--shadow:0 4px 15px rgba(0,0,0,.1);
      --shadow-lg:0 10px 30px rgba(0,0,0,.15);--transition:all .3s ease;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:var(--light-bg);color:var(--dark);line-height:1.75}
    .navbar{position:fixed;top:0;left:0;right:0;z-index:1000;background:var(--primary);padding:10px 5%;display:flex;justify-content:space-between;align-items:center;box-shadow:var(--shadow)}
    .navbar-brand{display:flex;align-items:center;gap:10px;text-decoration:none}
    .navbar-brand i{font-size:2rem;color:var(--accent)}
    .navbar-brand span{font-size:1.5rem;font-weight:700;color:var(--accent)}
    .nav-links{display:flex;gap:30px;list-style:none}
    .nav-links a{color:var(--white);text-decoration:none;font-weight:500;transition:var(--transition)}
    .nav-links a:hover,.nav-links a.active{color:var(--accent)}
    .nav-auth{display:flex;gap:12px;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 22px;border-radius:25px;border:none;cursor:pointer;font-weight:600;text-decoration:none;transition:var(--transition);font-family:inherit}
    .btn-primary{background:var(--accent);color:var(--primary)}
    .btn-primary:hover{background:#C4A030;transform:translateY(-2px)}
    .btn-outline{background:transparent;border:2px solid var(--accent);color:var(--accent)}
    .btn-outline:hover{background:var(--accent);color:var(--primary)}
    .btn-sm{padding:8px 16px;font-size:.85rem}
    .menu-toggle{display:none;flex-direction:column;gap:5px;cursor:pointer}
    .menu-toggle span{width:25px;height:3px;background:var(--white)}
    .mobile-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000;display:none}
    .mobile-overlay.active{display:block}
    .mobile-menu{position:fixed;top:0;left:-100%;height:100vh;width:80%;max-width:320px;z-index:2001;background:var(--primary);padding:15px 20px 30px;transition:var(--transition)}
    .mobile-menu.active{left:0}
    .mobile-menu-close{position:absolute;top:20px;right:20px;background:none;border:none;color:var(--white);font-size:1.5rem;cursor:pointer}
    .mobile-menu ul{list-style:none}
    .mobile-menu li{margin-bottom:3px}
    .mobile-menu a{color:var(--white);text-decoration:none;font-size:1rem}

    .hero{padding:120px 5% 60px;background:linear-gradient(135deg,var(--primary),#1a3a6e);color:var(--white);text-align:center}
    .hero h1{font-size:2.4rem;margin-bottom:10px}
    .hero h1 span{color:var(--accent)}
    .hero p{opacity:.9;max-width:800px;margin:0 auto}

    .container{max-width:1000px;margin:0 auto;padding:40px 5%}
    .card{background:var(--white);border-radius:18px;box-shadow:var(--shadow);padding:28px}
    .card h2{color:var(--primary);margin:18px 0 10px}
    .card h3{color:var(--primary);margin:16px 0 8px}
    .card p{color:var(--dark);opacity:.9}
    .card ul{margin:10px 0 10px 20px;color:var(--dark)}
    .note{background:rgba(212,175,55,.12);border:1px solid rgba(212,175,55,.35);padding:14px;border-radius:14px;margin:15px 0;color:#856404}
    .footer{background:var(--primary);color:var(--white);padding:15px 5%;text-align:center;margin-top:30px}
    .footer p{opacity:.85}
    .footer a{color:var(--accent);text-decoration:none}

    @media(max-width:992px){.nav-links{display:none}.menu-toggle{display:flex}}
      .navbar-logo {
          display: flex;
          align-items: center;
          gap: 0.5rem;
      }

      .navbar-logo img {
          height: 45px;
          width: auto;
      }

      @media (min-width: 768px) {
          .navbar-logo img {
              height: 40px;
          }
      }

      .navbar-logo span {
          font-size: 1.1rem;
          font-weight: 700;
          color: white;
      }

      @media (min-width: 768px) {
          .navbar-logo span {
              font-size: 1.35rem;
          }
      }


     .nav-links a {
        color: var(--white);
        text-decoration: none;
        font-weight: 500;
        transition: var(--transition);
        position: relative;            /* IMPORTANT pour la barre */
        padding: 6px 0;
        }

        /* Hover */
        .nav-links a:hover {
        color: var(--accent);
        }

        /* Barre sous le lien (page active) */
        .nav-links a.active::after {
        content: '';
        position: absolute;
        left: 0;
        bottom: -6px;
        width: 100%;
        height: 3px;
        background: var(--accent);
        border-radius: 3px;
        }

        /* Couleur du lien actif */
        .nav-links a.active {
        color: var(--accent);
        font-weight: 700;
        }

        /* Feedback clic (petit flash) */
        .nav-links a.clicked {
        opacity: 0.7;
        }

        .mobile-menu a {
        color: var(--white);
        text-decoration: none;
        font-size: 1rem;
        position: relative;
        padding: 6px 0;
        display: inline-block;
        }

        .mobile-menu a.active {
        color: var(--accent);
        font-weight: 700;
        }

        .mobile-menu a.active::after {
        content: '';
        position: absolute;
        left: 0;
        bottom: -1px;
        width: 100%;
        height: 1px;
        background: var(--accent);
        border-radius: 3px;
        }

        /* =========================================================
   SOCIAL VOTE - GLOBAL RESPONSIVE PACK (ANDROID FIRST)
   Colle ce bloc √† la FIN du <style> de chaque page.
   Objectif: 0 overflow, navbar clean, forms clean, mobile menu ok.
   ========================================================= */

html, body { max-width: 100%; overflow-x: hidden; }
* { box-sizing: border-box; min-width: 0; }
img, video, canvas { max-width: 100%; height: auto; }

/* -------------------------
   NAVBAR: mobile behavior
   ------------------------- */

/* Emp√™che les √©l√©ments navbar de d√©border */
.navbar {
  max-width: 100%;
  gap: 12px;
}

/* Sur petit √©cran, on cache les boutons auth dans la navbar
   et on laisse le menu hamburger g√©rer l'auth */
@media (max-width: 576px) {
  .nav-auth { display: none !important; }
}

/* Si ton menu toggle n‚Äôappara√Æt pas partout, force-le sur mobile */
@media (max-width: 992px) {
  .menu-toggle { display: flex !important; }
  .nav-links { display: none !important; }
}

/* -------------------------
   BUTTONS: safe sizing
   ------------------------- */
.btn {
  max-width: 100%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Sur mobile: boutons plus petits, mais restent sur 1 ligne quand possible */
@media (max-width: 576px) {
  .btn { padding: 10px 14px !important; border-radius: 14px !important; font-size: .95rem !important; }
  .btn-lg { padding: 12px 16px !important; font-size: 1rem !important; }
  .btn-sm { padding: 9px 12px !important; font-size: .85rem !important; }
}

/* Autoriser le retour √† la ligne uniquement sur les boutons "longs"
   => ajoute class="btn-wrap" sur les boutons qui ont du texte long */
.btn.btn-wrap { white-space: normal; line-height: 1.2; }

/* -------------------------
   LAYOUT: grids -> 1 col on mobile
   ------------------------- */

/* Beaucoup de tes pages utilisent .form-row => on force 1 colonne en mobile */
@media (max-width: 576px) {
  .form-row { grid-template-columns: 1fr !important; }
}

/* Tables: scroll horizontal */
.table-container,
.votes-table,
.referrals-table,
.candidates-table {
  width: 100%;
  overflow-x: auto;
}

/* -------------------------
   FORMS: no overflow
   ------------------------- */
input, select, textarea {
  width: 100%;
  max-width: 100%;
}

/* input-group: ne doit pas d√©passer */
.input-group { width: 100%; max-width: 100%; }

/* Referral input + bouton v√©rifier: stack sur mobile */
@media (max-width: 576px) {
  .referral-input-group { flex-direction: column !important; }
  .referral-input-group .btn { width: 100% !important; }
}

/* Auth: double boutons (login/register) => stack sur tr√®s petit √©cran */
@media (max-width: 420px) {
  .auth-two-buttons { grid-template-columns: 1fr !important; }
}

/* Modals: √©viter overflow */
.modal { max-width: 95vw !important; }
.modal-body { overflow-x: hidden; }

/* ==================================================
   FIX FINAL MOBILE & DESIGN (A ajouter √† la fin)
   ================================================== */

/* 1. Centrage des images de prix (Fix Android) */
.prize-image, .ad-image {
    margin-left: auto !important;
    margin-right: auto !important;
    display: block !important;
}

/* 2. Boutons longs (S'inscrire...) qui d√©bordent */
.btn {
    white-space: normal !important; /* Autorise le texte √† aller √† la ligne */
    height: auto !important;        /* La hauteur s'adapte au texte */
    line-height: 1.2 !important;
    text-align: center !important;
}

/* 3. Photos de profil PARFAITEMENT RONDES (Fix Ballon) */
.table-user img, 
.candidate-photo,
.mini-podium-photo,
.profile-photo,
.referral-user img,
.winner-photo {
    width: 45px !important;
    height: 45px !important;
    min-width: 45px !important; /* Emp√™che l'√©crasement */
    min-height: 45px !important;
    object-fit: cover !important; /* Coupe l'image sans la d√©former */
    border-radius: 50% !important;
    aspect-ratio: 1 / 1 !important; /* Force le carr√© strict */
}

/* 4. Tableaux Compacts sur Mobile */
@media (max-width: 576px) {
    /* R√©duire l'espace dans les cellules */
    .data-table th, .data-table td, 
    .referrals-table th, .referrals-table td,
    .votes-table th, .votes-table td {
        padding: 8px 5px !important; /* Beaucoup moins d'espace */
        font-size: 0.8rem !important; /* Texte plus petit */
    }
    
    /* Cacher les colonnes moins importantes (Optionnel : √† adapter selon tes besoins) */
    /* Exemple : on cache la date sur mobile pour gagner de la place */
    /* table td:nth-child(3), table th:nth-child(3) { display: none; } */
}

/* 5. Username qui d√©borde */
.credential-item .value, .profile-info h1 {
    word-break: break-all; /* Coupe le mot si trop long */
    overflow-wrap: break-word;
    font-size: 1.1rem !important; /* R√©duit un peu la taille */
}
    </style>

<!-- ================= SEO & SOCIAL SHARING ================= -->
<meta property="og:title" content="Social Vote - Ta communaut√© fait ta force">
<meta property="og:description" content="Participez, votez pour vos candidats pr√©f√©r√©s et gagnez des prix exceptionnels !">
<meta property="og:image" content="https://placehold.co/1200x630?text=Social+Vote"> <!-- Remplace par une belle image h√©berg√©e sur Cloudinary -->
<meta property="og:url" content="https://ton-site.com">
<meta name="twitter:card" content="summary_large_image">

<!-- ================= LIBRAIRIES (CONFETTI + FINGERPRINT) ================= -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>

<!-- OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "43ee5835-c6b1-45c8-ad82-6db5a374dcc7",
      allowLocalhostAsSecureOrigin: true, // Important pour tes tests locaux
    });
    
    // Forcer la demande d'autorisation (Slide Prompt)
    OneSignal.Slidedown.promptPush();
    
    // G√©rer l'identification utilisateur (quand connect√©)
    // On doit attendre que OneSignal soit pr√™t
    if (typeof currentUser !== 'undefined' && currentUser) {
        OneSignal.login(currentUser.id); // Nouvelle m√©thode v16 pour l'ID externe
        OneSignal.User.addTag("role", currentUser.role);
    }
  });
</script>
</head>
<body>
  <nav class="navbar">
    <a href="/" class="navbar-brand">
      <span class="navbar-logo"><img src="/assets/images/logo-white.png" alt="Social Vote" fetchpriority="high"></span>
    </a>
    <ul class="nav-links">
      <li><a href="/">Accueil</a></li>
      <li><a href="/vote/">Voter</a></li>
      <li><a href="/referral/">Parrainage</a></li>
      <li><a href="/history/">Historique</a></li>
      <li><a href="/sponsors/">Sponsors</a></li>
      <li><a href="/contact/">Contact</a></li>
      <li><a href="/rules/" class="active">R√®glement</a></li>
    </ul>
    <div class="nav-auth" id="navAuth">
      <a href="/auth/" class="btn btn-outline btn-sm">Connexion</a>
      <a href="/auth/?tab=candidate" class="btn btn-primary btn-sm">S'inscrire</a>
    </div>
    <div class="menu-toggle" id="menuToggle"><span></span><span></span><span></span></div>
  </nav>

  <div class="mobile-overlay" id="mobileOverlay"></div>
  <div class="mobile-menu" id="mobileMenu">
    <button class="mobile-menu-close" id="mobileMenuClose"><i class="fas fa-times"></i></button>
    <ul>
      <li><a href="/">Accueil</a></li>
      <li><a href="/vote/">Voter</a></li>
      <li><a href="/referral/">Parrainage</a></li>
      <li><a href="/history/">Historique</a></li>
      <li><a href="/sponsors/">Sponsors</a></li>
      <li><a href="/contact/">Contact</a></li>
      <li><a href="/rules/">R√®glement</a></li>
    </ul>
  </div>

  <header class="hero">
    <h1>üìú R√®glement <span>Social Vote</span></h1>
    <p>Ce r√®glement d√©finit les conditions de participation, les r√®gles de vote, le parrainage et les paiements. En vous inscrivant, vous acceptez ces r√®gles.</p>
  </header>

  <main class="container">
    <article class="card">
      <div class="note">
        <strong>Important :</strong> Les r√®gles sp√©cifiques peuvent varier selon le jeu (settings du jeu). Les informations affich√©es sur les pages du jeu font foi (dates/heures, prix, frais).
      </div>

      <h2>1) Conditions de participation</h2>
      <ul>
        <li>La plateforme est accessible aux visiteurs, utilisateurs et candidats.</li>
        <li>L‚Äôinscription comme candidat n√©cessite un compte et un paiement des frais d‚Äôinscription (selon le jeu).</li>
        <li>L‚Äôadministration valide les candidatures (preuve de paiement).</li>
      </ul>

      <h2>2) D√©roulement d‚Äôun jeu</h2>
      <ul>
        <li>Un jeu a une <strong>date/heure de d√©but</strong> et une <strong>date/heure de fin</strong>.</li>
        <li>Avant le d√©but : les candidats valid√©s sont visibles mais <strong>le vote est d√©sactiv√©</strong>.</li>
        <li>Au d√©but : le jeu passe automatiquement en <strong>actif</strong> et les votes sont ouverts.</li>
        <li>√Ä la fin : le jeu passe automatiquement en <strong>termin√©</strong> et le classement est calcul√©.</li>
        <li>Le jeu appara√Æt dans l‚Äôhistorique uniquement quand l‚Äôadmin l‚Äô<strong>archive</strong>.</li>
      </ul>

      <h2>3) R√®gles de vote</h2>
      <ul>
        <li>Vote gratuit : <strong>1 vote gratuit par candidat et par jeu</strong> (contr√¥le par utilisateur si connect√©, sinon par IP selon les r√©glages).</li>
        <li>Vote payant : achat de votes suppl√©mentaires (prix du vote d√©fini par le jeu).</li>
        <li>Le syst√®me peut afficher des publicit√©s (popup) √† l‚Äôouverture et avant certains votes gratuits.</li>
      </ul>

      <h2>4) Parrainage (candidats)</h2>
      <ul>
        <li>Chaque candidat re√ßoit un <strong>code de parrainage</strong> unique.</li>
        <li>Si un candidat s‚Äôinscrit avec un code valide :
          <ul>
            <li>Le filleul re√ßoit <strong>10 votes bonus</strong>.</li>
            <li>Le parrain re√ßoit <strong>15 votes bonus</strong>.</li>
          </ul>
        </li>
      </ul>

      <h2>5) Primes de parrainage (argent)</h2>
      <ul>
        <li>√Ä partir de <strong>10 filleuls</strong> sur un jeu : prime de <strong>1000 FCFA</strong>.</li>
        <li>Ensuite : <strong>+500 FCFA</strong> par tranche de 5 filleuls suppl√©mentaires.</li>
        <li>Le statut de paiement est visible dans le compte du parrain (En attente / Pay√©).</li>
        <li>Le paiement s‚Äôeffectue via Mobile Money selon le num√©ro fourni lors de l‚Äôinscription candidat.</li>
      </ul>

      <h2>6) Fraude et abus</h2>
      <ul>
        <li>Les tentatives de fraude (multi-votes abusifs, automation, etc.) peuvent entra√Æner annulation de votes et/ou bannissement.</li>
        <li>L‚Äôadministration se r√©serve le droit de v√©rifier et supprimer des votes suspects.</li>
      </ul>

      <h2>7) Paiements & remboursements</h2>
      <ul>
        <li>Les frais d‚Äôinscription et votes payants ne sont pas remboursables sauf cas exceptionnel d√©cid√© par l‚Äôadministration.</li>
        <li>Le gagnant ou le parrain doit fournir des informations valides (WhatsApp, Mobile Money).</li>
      </ul>

      <h2>8) Propri√©t√© & modifications</h2>
      <ul>
        <li>Social Vote peut modifier le r√®glement pour am√©liorer la plateforme.</li>
        <li>En cas de mise √† jour, la version affich√©e sur le site est la version applicable.</li>
      </ul>

      <div class="note">
        <strong>Contact :</strong> Pour toute question, utilisez la page <a href="/contact/" style="color:#856404;font-weight:800;text-decoration:underline;">Contact</a>.
      </div>

      <div style="margin-top:20px;display:flex;gap:12px;flex-wrap:wrap;justify-content:center;">
        <a class="btn btn-primary" href="/auth/?tab=register"><i class="fas fa-user-plus"></i> Cr√©er un compte</a>
        <a class="btn btn-outline" href="/vote/"><i class="fas fa-vote-yea"></i> Aller voter</a>
      </div>
    </article>
  </main>

  <footer class="footer">
    <p>&copy; 2026 Social Vote. Tous droits r√©serv√©s. | <a href="/contact/">Contact</a></p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const CONFIG = {
      SUPABASE_URL: 'https://ynymnvmilertakacfrhy.supabase.co',
      SUPABASE_ANON_KEY: 'sb_publishable_jbmKmsT4FxmiTfYUBajgOA_QxWz8j2K'
    };
    const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

    let currentUser = null;

    document.addEventListener('DOMContentLoaded', async () => {
      setActiveNavLinks();
      initMobileMenu();
      await checkAuth();
    });

    function initMobileMenu(){
      const menuToggle = document.getElementById('menuToggle');
      const mobileMenu = document.getElementById('mobileMenu');
      const mobileOverlay = document.getElementById('mobileOverlay');
      const mobileMenuClose = document.getElementById('mobileMenuClose');
      const open = ()=>{mobileMenu.classList.add('active');mobileOverlay.classList.add('active');}
      const close = ()=>{mobileMenu.classList.remove('active');mobileOverlay.classList.remove('active');}
      menuToggle.addEventListener('click', open);
      mobileMenuClose.addEventListener('click', close);
      mobileOverlay.addEventListener('click', close);
    }

    async function checkAuth(){
      const session = localStorage.getItem('socialvote_session');
      if(session){
        currentUser = JSON.parse(session);
        renderNavAuth();
        const navAuth = document.getElementById('navAuth');
        navAuth.innerHTML = `
          <a href="/profile/" class="btn btn-outline btn-sm">
            <i class="fas fa-user"></i> ${currentUser.full_name.split(' ')[0]}
          </a>
          <button class="btn btn-primary btn-sm" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        `;
      }
    }
    
    function setActiveNavLinks() {
  // 1. R√©cup√©rer le chemin actuel (ex: "/" ou "/vote/" ou "/vote/index.html")
  const path = window.location.pathname;

  // 2. S√©lectionner tous les liens du menu (desktop et mobile)
  const links = document.querySelectorAll('.nav-links a, .mobile-menu a');

  links.forEach(a => {
    // R√©cup√©rer le lien cible
    const href = a.getAttribute('href');
    
    // On enl√®ve d'abord la classe active partout pour nettoyer
    a.classList.remove('active');

    // 3. Logique de comparaison intelligente
    if (path === '/' || path.endsWith('/index.html') && path.split('/').length <= 2) {
        // === CAS : PAGE D'ACCUEIL ===
        // On active si le lien pointe vers la racine ou index.html
        if (href === '/' || href === 'index.html' || href === './index.html' || href === '../index.html') {
            // V√©rification suppl√©mentaire : ne pas activer si le lien contient un sous-dossier
            if (!href.includes('/vote') && !href.includes('/history') && !href.includes('/referral')) {
                a.classList.add('active');
            }
        }
    } else {
        // === CAS : PAGES INTERNES (Dossiers) ===
        // On r√©cup√®re le nom du dossier actuel (ex: "vote" dans "/vote/")
        // path.split('/') donne ["", "vote", ""] => on prend l'index 1
        const currentFolder = path.split('/')[1]; 

        // Si le lien contient le nom du dossier actuel, c'est le bon !
        if (currentFolder && href.includes(currentFolder)) {
            a.classList.add('active');
        }
    }
  });
}
    function logout(){localStorage.removeItem('socialvote_session');location.reload();}
  

    function renderNavAuth() {
  const navAuth = document.getElementById('navAuth');
  if (!navAuth) return;

  if (currentUser) {
    navAuth.innerHTML = `
      <a href="/auth/?tab=candidate" class="btn btn-primary btn-sm">
        <i class="fas fa-star"></i> S'inscrire comme candidat
      </a>
      <a href="/profile/" class="btn btn-outline btn-sm">
        <i class="fas fa-user"></i> ${currentUser.full_name.split(' ')[0]}
      </a>
      <button class="btn btn-outline btn-sm" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    `;

    // Mobile menu: remplacer Connexion/Inscription par Profil/D√©connexion
    patchMobileMenuForLoggedIn();
  } else {
    navAuth.innerHTML = `
      <a href="/auth/" class="btn btn-outline btn-sm">Connexion</a>
      <a href="/auth/?tab=register" class="btn btn-primary btn-sm">S'inscrire</a>
    `;

    patchMobileMenuForLoggedOut();
  }
}

function patchMobileMenuForLoggedIn() {
  const menu = document.querySelector('.mobile-menu ul');
  if (!menu) return;

  // Enlever anciens liens si pr√©sents
  menu.querySelectorAll('[data-auth-link]').forEach(el => el.remove());

  // Ajouter Profil + D√©connexion (si pas d√©j√†)
  const liProfile = document.createElement('li');
  liProfile.setAttribute('data-auth-link', 'true');
  liProfile.innerHTML = `<a href="/profile/">Mon Profil</a>`;

  const liCandidate = document.createElement('li');
  liCandidate.setAttribute('data-auth-link', 'true');
  liCandidate.innerHTML = `<a href="/auth/?tab=candidate">S'inscrire comme candidat</a>`;

  const liLogout = document.createElement('li');
  liLogout.setAttribute('data-auth-link', 'true');
  liLogout.innerHTML = `<a href="#" onclick="logout(); return false;">D√©connexion</a>`;

  menu.appendChild(liCandidate);
  menu.appendChild(liProfile);
  menu.appendChild(liLogout);
}

function patchMobileMenuForLoggedOut() {
  const menu = document.querySelector('.mobile-menu ul');
  if (!menu) return;

  menu.querySelectorAll('[data-auth-link]').forEach(el => el.remove());

  const liLogin = document.createElement('li');
  liLogin.setAttribute('data-auth-link', 'true');
  liLogin.innerHTML = `<a href="/auth/">Connexion</a>`;

  const liRegister = document.createElement('li');
  liRegister.setAttribute('data-auth-link', 'true');
  liRegister.innerHTML = `<a href="/auth/?tab=register">S'inscrire</a>`;

  menu.appendChild(liLogin);
  menu.appendChild(liRegister);
}

    // ==========================================
// ANALYTICS TRACKER (Mini Google Analytics)
// ==========================================

const Analytics = {
    currentVisitId: null,
    heartbeatInterval: null,

    init: async function() {
        // 1. R√©cup√©rer l'IP (Optionnel, sinon on stocke null et on se base sur le cookie visiteur)
        let ip = null;
        try {
            const res = await fetch('https://api.ipify.org?format=json');
            const json = await res.json();
            ip = json.ip;
        } catch(e) {}

        // 2. Enregistrer la visite
        const { data, error } = await supabaseClient
            .from('page_visits')
            .insert([{
                page_path: window.location.pathname,
                ip_address: ip,
                user_id: currentUser ? currentUser.id : null,
                user_agent: navigator.userAgent,
                referrer: document.referrer
            }])
            .select()
            .single();

        if (data) {
            this.currentVisitId = data.id;
            // 3. Lancer le chronom√®tre (toutes les 10s)
            this.startHeartbeat();
        }
    },

    startHeartbeat: function() {
        this.heartbeatInterval = setInterval(async () => {
            if (!this.currentVisitId) return;
            
            // On ajoute 10 secondes √† la dur√©e
            // Note: On utilise une RPC pour √™tre s√ªr d'additionner c√¥t√© serveur
            // Ou un simple update si RPC trop complexe
            await supabaseClient.rpc('update_visit_duration', {
                visit_id: this.currentVisitId,
                seconds: 3
            });
        }, 3000); // 10 secondes
    }
};

// D√©marrer au chargement
document.addEventListener('DOMContentLoaded', () => Analytics.init());

// Arr√™ter quand on quitte la page (pour √™tre propre)
window.addEventListener('beforeunload', () => {
    if (Analytics.heartbeatInterval) clearInterval(Analytics.heartbeatInterval);
});
  </script>
</body>
</html>
