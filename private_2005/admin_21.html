<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Social Vote</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="../assets/images/favicon.png">
    <style>
        /* ============================================
           SOCIAL VOTE - ADMIN PANEL STYLES
           ============================================ */
        
        :root {
            --primary: #0A1F44;
            --primary-light: #1a3a6e;
            --accent: #D4AF37;
            --white: #FFFFFF;
            --light-bg: #F8F9FA;
            --gray: #6C757D;
            --dark-gray: #343A40;
            --success: #28A745;
            --danger: #DC3545;
            --warning: #FFC107;
            --info: #17A2B8;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
            --sidebar-width: 280px;
            --header-height: 70px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--light-bg);
            color: var(--dark-gray);
            line-height: 1.6;
        }
        
        /* ========== SIDEBAR ========== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--white);
            z-index: 1000;
            overflow-y: auto;
            transition: var(--transition);
        }
        
        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .sidebar-header i {
            font-size: 2rem;
            color: var(--accent);
        }
        
        .sidebar-header h2 {
            font-size: 1.3rem;
            color: var(--accent);
        }
        
        .sidebar-header span {
            font-size: 0.75rem;
            opacity: 0.7;
            display: block;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .menu-section {
            margin-bottom: 20px;
        }
        
        .menu-section-title {
            padding: 10px 20px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.5;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
            font-size: 0.95rem;
        }
        
        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            color: var(--white);
        }
        
        .menu-item.active {
            background: rgba(212, 175, 55, 0.2);
            color: var(--accent);
            border-left: 4px solid var(--accent);
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
        }
        
        .menu-item .badge {
            margin-left: auto;
            background: var(--danger);
            color: var(--white);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        
        /* ========== MAIN CONTENT ========== */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }
        
        /* ========== HEADER ========== */
        .admin-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--white);
            height: var(--header-height);
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary);
            cursor: pointer;
        }
        
        .page-title {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .header-time {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .admin-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        
        .admin-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent);
        }
        
        .admin-profile .info .name {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
        }
        
        .admin-profile .info .role {
            font-size: 0.75rem;
            color: var(--gray);
        }
        
        /* ========== PAGE CONTENT ========== */
        .page-content {
            padding: 30px;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ========== CARDS ========== */
        .card {
            background: var(--white);
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .card-header h3 {
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .card-header h3 i {
            color: var(--accent);
        }
        
        .card-body {
            padding: 25px;
        }
        
        .card-footer {
            padding: 15px 25px;
            background: var(--light-bg);
            border-top: 1px solid #e0e0e0;
        }
        
        /* ========== STATS GRID ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: var(--transition);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card .icon {
            width: 70px;
            height: 70px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        
        .stat-card .icon.blue {
            background: rgba(23, 162, 184, 0.1);
            color: var(--info);
        }
        
        .stat-card .icon.green {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        
        .stat-card .icon.gold {
            background: rgba(212, 175, 55, 0.1);
            color: var(--accent);
        }
        
        .stat-card .icon.red {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        .stat-card .icon.purple {
            background: rgba(111, 66, 193, 0.1);
            color: #6f42c1;
        }
        
        .stat-card .info h4 {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-card .info p {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .stat-card .info .trend {
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        .stat-card .info .trend.up {
            color: var(--success);
        }
        
        .stat-card .info .trend.down {
            color: var(--danger);
        }
        
        /* ========== BUTTONS ========== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--accent);
            color: var(--primary);
        }
        
        .btn-primary:hover {
            background: #C4A030;
        }
        
        .btn-secondary {
            background: var(--primary);
            color: var(--white);
        }
        
        .btn-success {
            background: var(--success);
            color: var(--white);
        }
        
        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--primary);
        }
        
        .btn-info {
            background: var(--info);
            color: var(--white);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: var(--white);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        .btn-lg {
            padding: 15px 30px;
            font-size: 1rem;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* ========== TABLES ========== */
        .table-container {
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table thead {
            background: var(--primary);
            color: var(--white);
        }
        
        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
        }
        
        .data-table th {
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: var(--transition);
        }
        
        .data-table tbody tr:hover {
            background: var(--light-bg);
        }
        
        .data-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .table-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .table-user img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .table-user .name {
            font-weight: 600;
            color: var(--primary);
        }
        
        .table-user .email {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        /* ========== BADGES ========== */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        
        .badge-danger {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        .badge-warning {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
        }
        
        .badge-info {
            background: rgba(23, 162, 184, 0.1);
            color: var(--info);
        }
        
        .badge-primary {
            background: rgba(10, 31, 68, 0.1);
            color: var(--primary);
        }
        
        .badge-gold {
            background: rgba(212, 175, 55, 0.1);
            color: var(--accent);
        }
        
        /* ========== FORMS ========== */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .form-group label .required {
            color: var(--danger);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .form-control::placeholder {
            color: #aaa;
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        .input-group {
            position: relative;
        }
        
        .input-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .input-group .form-control {
            padding-left: 45px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-check {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-check input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
        }
        
        /* ========== FILE UPLOAD ========== */
        .file-upload {
            border: 2px dashed #e0e0e0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }
        
        .file-upload:hover {
            border-color: var(--accent);
            background: rgba(212, 175, 55, 0.05);
        }
        
        .file-upload.has-file {
            border-color: var(--success);
            background: rgba(40, 167, 69, 0.05);
        }
        
        .file-upload input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-upload i {
            font-size: 2rem;
            color: var(--gray);
            margin-bottom: 10px;
        }
        
        .file-upload p {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .file-preview {
            max-width: 150px;
            max-height: 150px;
            border-radius: 10px;
            margin: 10px auto 0;
            display: none;
        }
        
        .file-upload.has-file .file-preview {
            display: block;
        }
        
        /* ========== TABS ========== */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 25px;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            position: relative;
        }
        
        .tab-btn:hover {
            color: var(--primary);
        }
        
        .tab-btn.active {
            color: var(--primary);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ========== MODALS ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--white);
            border-radius: 15px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
        }
        
        .modal.large {
            max-width: 900px;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary);
            color: var(--white);
            border-radius: 15px 15px 0 0;
        }
        
        .modal-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-header h3 i {
            color: var(--accent);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .modal-close:hover {
            color: var(--accent);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            background: var(--light-bg);
            border-radius: 0 0 15px 15px;
        }
        
        /* ========== ALERTS ========== */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid var(--warning);
        }
        
        .alert-info {
            background: rgba(23, 162, 184, 0.1);
            color: var(--info);
            border: 1px solid var(--info);
        }
        
        /* ========== CHARTS ========== */
        .chart-container {
            position: relative;
            height: 350px;
        }
        
        /* ========== FILTERS ========== */
        .filters-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--light-bg);
            border-radius: 10px;
        }
        
        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-item label {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        .filter-item select,
        .filter-item input {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
        }
        
        /* ========== PRIZE CARDS ========== */
        .prizes-editor {
            display: grid;
            gap: 20px;
        }
        
        .prize-card-editor {
            background: var(--light-bg);
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }
        
        .prize-card-editor .position {
            position: absolute;
            top: -10px;
            left: 20px;
            background: var(--accent);
            color: var(--primary);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
        }
        
        .prize-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .prize-photo-upload {
            width: 150px;
            height: 150px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }
        
        .prize-photo-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .prize-photo-upload input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        /* ========== GAME STATUS ========== */
        .game-status-card {
            background: var(--white);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            box-shadow: var(--shadow);
        }
        
        .game-status-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .game-status-info .icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .game-status-info .icon.active {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        
        .game-status-info .icon.pending {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
        }
        
        .game-status-info .icon.ended {
            background: rgba(108, 117, 125, 0.1);
            color: var(--gray);
        }
        
        .game-status-info .details h4 {
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .game-status-info .details p {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        /* ========== LOADING ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            flex-direction: column;
            gap: 20px;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-bg);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========== TOAST ========== */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 3001;
        }
        
        .toast {
            background: var(--primary);
            color: var(--white);
            padding: 15px 25px;
            border-radius: 10px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            box-shadow: var(--shadow-lg);
            max-width: 350px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); color: var(--primary); }
        
        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        /* ========== FINANCIAL STATS ========== */
        .financial-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .financial-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }
        
        .financial-card .amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 5px;
        }
        
        .financial-card .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .financial-card.profit {
            background: linear-gradient(135deg, var(--success), #1e7e34);
        }
        
        .financial-card.expense {
            background: linear-gradient(135deg, var(--danger), #bd2130);
        }
        
        /* ========== REFERRAL PAYMENTS ========== */
        .referral-payment-card {
            background: var(--light-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .referral-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .referral-user-info img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .referral-user-info .details h5 {
            color: var(--primary);
            margin-bottom: 3px;
        }
        
        .referral-user-info .details p {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        .referral-stats {
            display: flex;
            gap: 20px;
        }
        
        .referral-stat {
            text-align: center;
        }
        
        .referral-stat .value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .referral-stat .label {
            font-size: 0.75rem;
            color: var(--gray);
        }
        
        .referral-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* ========== ADS SECTION ========== */
        .ad-preview {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .ad-preview img,
        .ad-preview video {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
        }
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 1200px) {
            .sidebar {
                left: calc(-1 * var(--sidebar-width));
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                display: block;
            }
        }
        
        @media (max-width: 768px) {
            .page-content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .modal {
                margin: 10px;
                max-height: 95vh;
            }
            
            .header-time {
                display: none;
            }
            
            .admin-profile .info {
                display: none;
            }
            
            .financial-cards {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 576px) {
            .page-title {
                font-size: 1.2rem;
            }
            
            .filters-bar {
                flex-direction: column;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn-group .btn {
                width: 100%;
            }
            
            .financial-cards {
                grid-template-columns: 1fr;
            }
            
            .referral-payment-card {
                flex-direction: column;
                text-align: center;
            }
            
            .referral-user-info {
                flex-direction: column;
            }
        }
        
        /* Overlay for sidebar on mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
            .navbar-logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.navbar-logo img {
    height: 50px;
    width: auto;
}

@media (min-width: 768px) {
    .navbar-logo img {
        height: 40px;
    }
}

.navbar-logo span {
    font-size: 1.1rem;
    font-weight: 700;
    color: white;
}

@media (min-width: 768px) {
    .navbar-logo span {
        font-size: 1.35rem;
    }
}
.sidebar-subtitle {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
        }
    </style>

<!-- ================= SEO & SOCIAL SHARING ================= -->
<meta property="og:title" content="Social Vote - Ta communauté fait ta force">
<meta property="og:description" content="Participez, votez pour vos candidats préférés et gagnez des prix exceptionnels !">
<meta property="og:image" content="https://placehold.co/1200x630?text=Social+Vote"> <!-- Remplace par une belle image hébergée sur Cloudinary -->
<meta property="og:url" content="https://ton-site.com">
<meta name="twitter:card" content="summary_large_image">

<!-- ================= LIBRAIRIES (CONFETTI + FINGERPRINT) ================= -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
</head>
<body>
    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="navbar-logo"><img src="../assets/images/logo-footer.png" alt="Social Vote" onerror="this.style.display='none'"></div>
            <div class="sidebar-subtitle">Panel d'Administration</div>
        </div>
        
        <nav class="sidebar-menu">
            <div class="menu-section">
                <p class="menu-section-title">Principal</p>
                <button class="menu-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </button>
                <button class="menu-item" data-section="users">
                    <i class="fas fa-users"></i>
                    <span>Utilisateurs</span>
                </button>
                <button class="menu-item" data-section="games">
                    <i class="fas fa-gamepad"></i>
                    <span>Jeux</span>
                </button>
                <button class="menu-item" data-section="candidates">
                    <i class="fas fa-user-check"></i>
                    <span>Candidatures</span>
                    <span class="badge" id="pendingCandidatesCount">0</span>
                </button>
                <button class="menu-item" data-section="votes">
                    <i class="fas fa-vote-yea"></i>
                    <span>Votes</span>
                </button>
            </div>
            
            <div class="menu-section">
                <p class="menu-section-title">Finances</p>
                <button class="menu-item" data-section="referrals">
                    <i class="fas fa-user-friends"></i>
                    <span>Parrainage</span>
                </button>
                <button class="menu-item" data-section="finances">
                    <i class="fas fa-chart-line"></i>
                    <span>Finances</span>
                </button>
            </div>
            
            <div class="menu-section">
                <p class="menu-section-title">Contenu</p>
                <button class="menu-item" data-section="ads">
                    <i class="fas fa-ad"></i>
                    <span>Publicités</span>
                </button>
                <button class="menu-item" data-section="sponsors">
                    <i class="fas fa-handshake"></i>
                    <span>Sponsors</span>
                </button>
                <button class="menu-item" data-section="testimonials">
                    <i class="fas fa-quote-left"></i>
                    <span>Témoignages</span>
                </button>
            </div>
            
            <div class="menu-section">
                <p class="menu-section-title">Système</p>
                <button class="menu-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Paramètres</span>
                </button>
                <button class="menu-item" data-section="logs">
                    <i class="fas fa-history"></i>
                    <span>Logs</span>
                </button>
            </div>
            
            <div class="menu-section" style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <a href="../index.html" class="menu-item">
                    <i class="fas fa-external-link-alt"></i>
                    <span>Voir le site</span>
                </a>
                <button class="menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Déconnexion</span>
                </button>
            </div>
        </nav>
    </aside>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- ========== MAIN CONTENT ========== -->
    <div class="main-content">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
            </div>
            
            <div class="header-right">
                <div class="header-time" id="headerTime"></div>
                <div class="admin-profile" id="adminProfile">
                    <img src="https://placehold.co/40x40?text=A" alt="Admin" id="adminPhoto">
                    <div class="info">
                        <span class="name" id="adminName">Admin</span>
                        <span class="role">Administrateur</span>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Page Content -->
        <div class="page-content">
            <!-- ========== DASHBOARD ========== -->
            <section class="content-section active" id="dashboardSection">
                <!-- Stats -->
                <div class="stats-grid" id="dashboardStats">
                    <!-- Dynamically populated -->
                </div>
                
                <!-- Current Game Status -->
                <div id="currentGameStatus"></div>
                
                <!-- Charts Row -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-bottom: 25px;">
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-area"></i> Activité des 30 derniers jours</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="activityChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-pie"></i> Répartition des Votes</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="votesDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-clock"></i> Activité Récente</h3>
                    </div>
                    <div class="card-body">
                        <div id="recentActivity">
                            <div class="empty-state">
                                <i class="fas fa-history"></i>
                                <p>Chargement...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- ========== USERS ========== -->
            <section class="content-section" id="usersSection">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-users"></i> Gestion des Utilisateurs</h3>
                        <div class="btn-group">
                            <button class="btn btn-outline btn-sm" onclick="exportUsers()">
                                <i class="fas fa-download"></i> Exporter
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="filters-bar">
                            <div class="filter-item">
                                <label>Rôle:</label>
                                <select id="userRoleFilter" onchange="filterUsers()">
                                    <option value="">Tous</option>
                                    <option value="user">Utilisateur</option>
                                    <option value="candidate">Candidat</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label>Recherche:</label>
                                <input type="text" id="userSearchInput" placeholder="Nom, email..." onkeyup="filterUsers()">
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="data-table" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Utilisateur</th>
                                        <th>Téléphone</th>
                                        <th>Rôle</th>
                                        <th>Inscrit le</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Dynamically populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- ========== GAMES ========== -->
            <section class="content-section" id="gamesSection">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-gamepad"></i> Gestion des Jeux</h3>
                        <button class="btn btn-primary" onclick="openCreateGameModal()">
                            <i class="fas fa-plus"></i> Créer un Jeu
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="tabs">
                            <button class="tab-btn active" data-tab="allGames">Tous</button>
                            <button class="tab-btn" data-tab="activeGames">Actifs</button>
                            <button class="tab-btn" data-tab="pendingGames">En attente</button>
                            <button class="tab-btn" data-tab="endedGames">Terminés</button>
                            <button class="tab-btn" data-tab="archivedGames">Archivés</button>
                        </div>
                        
                        <div id="gamesContent">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- ========== CANDIDATES ========== -->
            <section class="content-section" id="candidatesSection">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-user-check"></i> Candidatures</h3>
                    </div>
                    <div class="card-body">
                        <div class="tabs">
                            <button class="tab-btn active" data-tab="pendingCandidates">En attente</button>
                            <button class="tab-btn" data-tab="approvedCandidates">Approuvées</button>
                            <button class="tab-btn" data-tab="rejectedCandidates">Rejetées</button>
                        </div>
                        
                        <div id="candidatesContent">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- ========== VOTES ========== -->
            <section class="content-section" id="votesSection">
                <div class="stats-grid" id="votesStats">
                    <!-- Dynamically populated -->
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-vote-yea"></i> Gestion des Votes</h3>
                        <button class="btn btn-primary" onclick="openAddVotesModal()">
                            <i class="fas fa-plus"></i> Ajouter des Votes
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="filters-bar">
                            <div class="filter-item">
                                <label>Jeu:</label>
                                <select id="voteGameFilter" onchange="filterVotes()">
                                    <option value="">Tous les jeux</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label>Type:</label>
                                <select id="voteTypeFilter" onchange="filterVotes()">
                                    <option value="">Tous</option>
                                    <option value="free">Gratuit</option>
                                    <option value="paid">Payant</option>
                                    <option value="bonus">Bonus</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Votant</th>
                                        <th>Candidat</th>
                                        <th>Jeu</th>
                                        <th>Type</th>
                                        <th>Votes</th>
                                        <th>Montant</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="votesTableBody">
                                    <!-- Dynamically populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- ========== REFERRALS ========== -->
            <section class="content-section" id="referralsSection">
                <div class="stats-grid" id="referralStats">
                    <!-- Dynamically populated -->
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-user-friends"></i> Parrainages & Paiements</h3>
                    </div>
                    <div class="card-body">
                        <div class="tabs">
                            <button class="tab-btn active" data-tab="eligibleReferrers">Éligibles au paiement</button>
                            <button class="tab-btn" data-tab="allReferrers">Tous les parrains</button>
                            <button class="tab-btn" data-tab="paidReferrers">Payés</button>
                        </div>
                        
                        <div id="referralsContent">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- ========== FINANCES ========== -->
            <section class="content-section" id="financesSection">
                <div class="financial-cards" id="financialCards">
                    <!-- Dynamically populated -->
                </div>
                
                <div class="card" style="margin-bottom: 25px;">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-line"></i> Évolution Financière</h3>
                        <div class="filters-bar" style="margin: 0; padding: 0; background: transparent;">
                            <select id="financePeriodFilter" onchange="loadFinancialChart()">
                                <option value="30">30 derniers jours</option>
                                <option value="90">3 derniers mois</option>
                                <option value="365">Cette année</option>
                                <option value="all">Tout</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="financialChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-list"></i> Détails par Jeu</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Jeu</th>
                                        <th>Inscriptions</th>
                                        <th>Votes Payants</th>
                                        <th>Total Revenus</th>
                                        <th>Primes Parrainage</th>
                                        <th>Bénéfice Net</th>
                                    </tr>
                                </thead>
                                <tbody id="financesByGameBody">
                                    <!-- Dynamically populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            
            
            <!-- ========== ADS ========== -->
            <section class="content-section" id="adsSection">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-ad"></i> Gestion des Publicités</h3>
                        <button class="btn btn-primary" onclick="openCreateAdModal()">
                            <i class="fas fa-plus"></i> Nouvelle Publicité
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Stats Globales -->
                        <div class="stats-grid" id="adsGlobalStats">
                            <div class="stat-card"><div class="icon blue"><i class="fas fa-eye"></i></div><div class="info"><h4 id="totalAdViews">0</h4><p>Vues Totales</p></div></div>
                            <div class="stat-card"><div class="icon green"><i class="fas fa-mouse-pointer"></i></div><div class="info"><h4 id="totalAdClicks">0</h4><p>Clics Totaux</p></div></div>
                            <div class="stat-card"><div class="icon gold"><i class="fas fa-chart-line"></i></div><div class="info"><h4 id="avgAdCTR">0%</h4><p>CTR Moyen</p></div></div>
                            <div class="stat-card"><div class="icon purple"><i class="fas fa-clock"></i></div><div class="info"><h4 id="totalAdTime">0s</h4><p>Temps Visionnage</p></div></div>
                        </div>

                        <!-- Graphique -->
                        <div class="chart-container" style="margin-bottom: 30px;">
                            <canvas id="adsChart"></canvas>
                        </div>

                        <!-- Tabs -->
                        <div class="tabs">
                            <button class="tab-btn active" data-tab="homepageAds">Accueil (Carrousel)</button>
                            <button class="tab-btn" data-tab="popupAds">Popup Ouverture</button>
                            <button class="tab-btn" data-tab="voteAds">Avant Vote</button>
                        </div>
                        
                        <div id="adsContent">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- ========== SPONSORS ========== -->
            <section class="content-section" id="sponsorsSection">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-handshake"></i> Gestion des Sponsors</h3>
                        <button class="btn btn-primary" onclick="openCreateSponsorModal()">
                            <i class="fas fa-plus"></i> Ajouter un Sponsor
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="sponsorsContent">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- ========== TESTIMONIALS ========== -->
            <section class="content-section" id="testimonialsSection">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-quote-left"></i> Témoignages</h3>
                        <button class="btn btn-primary" onclick="openCreateTestimonialModal()">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="testimonialsContent">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- ========== SETTINGS ========== -->
            <section class="content-section" id="settingsSection">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-cog"></i> Paramètres du Site</h3>
                    </div>
                    <div class="card-body">
                        <form id="settingsForm" onsubmit="saveSettings(event)">
                            <h4 style="color: var(--primary); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--light-bg);">
                                <i class="fas fa-info-circle" style="color: var(--accent);"></i> Informations Générales
                            </h4>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nom du site</label>
                                    <input type="text" class="form-control" id="settingSiteName" value="Social Vote">
                                </div>
                                <div class="form-group">
                                    <label>Slogan</label>
                                    <input type="text" class="form-control" id="settingTagline" value="Ta communauté fait ta force">
                                </div>
                            </div>
                            
                            <h4 style="color: var(--primary); margin: 30px 0 20px; padding-bottom: 10px; border-bottom: 2px solid var(--light-bg);">
                                <i class="fas fa-money-bill" style="color: var(--accent);"></i> Informations de Paiement
                            </h4>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Numéro MTN MoMo</label>
                                    <input type="text" class="form-control" id="settingMTN" value="2290190086267">
                                </div>
                                <div class="form-group">
                                    <label>Numéro Moov Money</label>
                                    <input type="text" class="form-control" id="settingMoov" value="2290155956683">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Numéro Celtiis Cash</label>
                                    <input type="text" class="form-control" id="settingCeltiis" value="22940304751">
                                </div>
                                <div class="form-group">
                                    <label>Nom du bénéficiaire</label>
                                    <input type="text" class="form-control" id="settingRecipient" value="Josias Akodjenou">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Numéro WhatsApp</label>
                                <input type="text" class="form-control" id="settingWhatsapp" value="2290190086267">
                            </div>
                            
                            <h4 style="color: var(--primary); margin: 30px 0 20px; padding-bottom: 10px; border-bottom: 2px solid var(--light-bg);">
                                <i class="fas fa-gift" style="color: var(--accent);"></i> Programme de Parrainage
                            </h4>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Votes bonus parrain</label>
                                    <input type="number" class="form-control" id="settingReferrerBonus" value="15">
                                </div>
                                <div class="form-group">
                                    <label>Votes bonus filleul</label>
                                    <input type="number" class="form-control" id="settingRefereeBonus" value="10">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Prime pour 10 filleuls (FCFA)</label>
                                    <input type="number" class="form-control" id="settingBonus10" value="1000">
                                </div>
                                <div class="form-group">
                                    <label>Prime par tranche de 5 supplémentaires (FCFA)</label>
                                    <input type="number" class="form-control" id="settingBonus5" value="500">
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Enregistrer les paramètres
                            </button>
                        </form>
                    </div>
                </div>
            </section>
            
            <!-- ========== LOGS ========== -->
            <section class="content-section" id="logsSection">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-history"></i> Journal d'Activité</h3>
                        <button class="btn btn-outline btn-sm" onclick="exportLogs()">
                            <i class="fas fa-download"></i> Exporter
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="filters-bar">
                            <div class="filter-item">
                                <label>Type:</label>
                                <select id="logTypeFilter" onchange="filterLogs()">
                                    <option value="">Tous</option>
                                    <option value="login">Connexions</option>
                                    <option value="vote">Votes</option>
                                    <option value="signup">Inscriptions</option>
                                    <option value="admin">Actions Admin</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label>Date:</label>
                                <input type="date" id="logDateFilter" onchange="filterLogs()">
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Utilisateur</th>
                                        <th>Action</th>
                                        <th>Description</th>
                                        <th>IP</th>
                                    </tr>
                                </thead>
                                <tbody id="logsTableBody">
                                    <!-- Dynamically populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <!-- ========== CREATE GAME MODAL ========== -->
    <div class="modal-overlay" id="createGameModal">
        <div class="modal large">
            <div class="modal-header">
                <h3><i class="fas fa-gamepad"></i> Créer un Nouveau Jeu</h3>
                <button class="modal-close" onclick="closeModal('createGameModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createGameForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Titre du jeu <span class="required">*</span></label>
                            <input type="text" class="form-control" id="gameTitle" required placeholder="Ex: Jeu de Noël 2026">
                        </div>
                        <div class="form-group">
                            <label>Nombre de gagnants <span class="required">*</span></label>
                            <input type="number" class="form-control" id="gameWinnersCount" value="3" min="1" max="10" required onchange="updatePrizesEditor()">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="gameDescription" placeholder="Description du jeu..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date et heure de début <span class="required">*</span></label>
                            <input type="datetime-local" class="form-control" id="gameStartTime" required>
                        </div>
                        <div class="form-group">
                            <label>Date et heure de fin <span class="required">*</span></label>
                            <input type="datetime-local" class="form-control" id="gameEndTime" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Frais d'inscription (FCFA) <span class="required">*</span></label>
                            <input type="number" class="form-control" id="gameRegistrationFee" value="500" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Prix du vote (FCFA) <span class="required">*</span></label>
                            <input type="number" class="form-control" id="gameVotePrice" value="50" min="1" required>
                        </div>
                    </div>
                    
                    <h4 style="color: var(--primary); margin: 30px 0 20px; padding-bottom: 10px; border-bottom: 2px solid var(--light-bg);">
                        <i class="fas fa-trophy" style="color: var(--accent);"></i> Prix à Gagner
                    </h4>
                    
                    <div class="prizes-editor" id="prizesEditor">
                        <!-- Dynamically populated -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('createGameModal')">Annuler</button>
                <button class="btn btn-primary" onclick="createGame()">
                    <i class="fas fa-check"></i> Créer le Jeu
                </button>
            </div>
        </div>
    </div>
    
    <!-- ========== ADD VOTES MODAL ========== -->
    <div class="modal-overlay" id="addVotesModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> Ajouter des Votes</h3>
                <button class="modal-close" onclick="closeModal('addVotesModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addVotesForm">
                    <div class="form-group">
                        <label>Jeu <span class="required">*</span></label>
                        <select class="form-control" id="voteGameSelect" required onchange="loadGameCandidates()">
                            <option value="">Sélectionnez un jeu</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Candidat <span class="required">*</span></label>
                        <select class="form-control" id="voteCandidateSelect" required>
                            <option value="">Sélectionnez un candidat</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Type de vote <span class="required">*</span></label>
                            <select class="form-control" id="voteTypeSelect" required>
                                <option value="free">Gratuit</option>
                                <option value="paid">Payant</option>
                                <option value="bonus">Bonus</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nombre de votes <span class="required">*</span></label>
                            <input type="number" class="form-control" id="voteCountInput" value="1" min="1" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Montant payé (FCFA)</label>
                        <input type="number" class="form-control" id="voteAmountInput" value="0" min="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addVotesModal')">Annuler</button>
                <button class="btn btn-success" onclick="addVotes()">
                    <i class="fas fa-check"></i> Ajouter
                </button>
            </div>
        </div>
    </div>
    
    <!-- ========== CREATE AD MODAL ========== -->
    <div class="modal-overlay" id="createAdModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-ad"></i> Nouvelle Publicité</h3>
                <button class="modal-close" onclick="closeModal('createAdModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createAdForm">
                    <div class="form-group">
                        <label>Position <span class="required">*</span></label>
                        <select class="form-control" id="adPosition" required>
                            <option value="homepage_carousel">Page d'accueil (Carrousel)</option>
                            <option value="vote_popup">Popup à l'ouverture</option>
                            <option value="vote_before">Avant vote gratuit</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Titre <span class="required">*</span></label>
                        <input type="text" class="form-control" id="adTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="adDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Média (Image ou Vidéo) <span class="required">*</span></label>
                        <div class="file-upload" id="adMediaUpload">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Cliquez pour uploader une image ou vidéo</p>
                            <input type="file" accept="image/*,video/*" id="adMediaInput" onchange="previewAdMedia(this)">
                            <img src="" alt="" class="file-preview" id="adMediaPreview">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Texte du bouton</label>
                            <input type="text" class="form-control" id="adButtonText" placeholder="En savoir plus">
                        </div>
                        <div class="form-group">
                            <label>Lien du bouton</label>
                            <input type="url" class="form-control" id="adButtonLink" placeholder="https://...">
                        </div>
                    </div>
                    
                    <div class="form-check">
                        <input type="checkbox" id="adIsActive" checked>
                        <label for="adIsActive">Publicité active</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('createAdModal')">Annuler</button>
                <button class="btn btn-primary" onclick="createAd()">
                    <i class="fas fa-check"></i> Créer
                </button>
            </div>
        </div>
    </div>
    
    <!-- ========== VIEW CANDIDATE MODAL ========== -->
    <div class="modal-overlay" id="viewCandidateModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-user"></i> Détails de la Candidature</h3>
                <button class="modal-close" onclick="closeModal('viewCandidateModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="candidateDetails">
                <!-- Dynamically populated -->
            </div>
            <div class="modal-footer" id="candidateActions">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>
    
    <!-- ========== CREATE SPONSOR MODAL ========== -->
<div class="modal-overlay" id="createSponsorModal">
  <div class="modal">
    <div class="modal-header">
      <h3><i class="fas fa-handshake"></i> Ajouter un Sponsor</h3>
      <button class="modal-close" onclick="closeModal('createSponsorModal')">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="createSponsorForm">
        <div class="form-group">
          <label>Nom <span class="required">*</span></label>
          <input class="form-control" id="sponsorName" required placeholder="Nom du sponsor">
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea class="form-control" id="sponsorDescription" placeholder="Description..."></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Site web</label>
            <input class="form-control" id="sponsorWebsite" placeholder="https://...">
          </div>
          <div class="form-group">
            <label>Tier</label>
            <select class="form-control" id="sponsorTier">
              <option value="bronze">Bronze</option>
              <option value="silver">Silver</option>
              <option value="gold">Gold</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Logo (image) <span class="required">*</span></label>
          <div class="file-upload" id="sponsorLogoUpload">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Cliquez pour uploader le logo</p>
            <input type="file" accept="image/*" id="sponsorLogoInput" onchange="previewSponsorLogo(this)">
            <img class="file-preview" id="sponsorLogoPreview" alt="">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Ordre d'affichage</label>
            <input type="number" class="form-control" id="sponsorOrder" value="0" min="0">
          </div>
          <div class="form-group" style="display:flex;align-items:center;gap:10px;">
            <input type="checkbox" id="sponsorActive" checked style="width:18px;height:18px;accent-color:var(--accent)">
            <label for="sponsorActive" style="margin:0;">Actif</label>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('createSponsorModal')">Annuler</button>
      <button class="btn btn-primary" onclick="createSponsor()">
        <i class="fas fa-check"></i> Ajouter
      </button>
    </div>
  </div>
</div>

<!-- ========== CREATE TESTIMONIAL MODAL ========== -->
<div class="modal-overlay" id="createTestimonialModal">
  <div class="modal">
    <div class="modal-header">
      <h3><i class="fas fa-quote-left"></i> Ajouter un Témoignage</h3>
      <button class="modal-close" onclick="closeModal('createTestimonialModal')">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="createTestimonialForm">
        <div class="form-group">
          <label>Nom <span class="required">*</span></label>
          <input class="form-control" id="testiName" required placeholder="Nom de la personne">
        </div>

        <div class="form-group">
          <label>Témoignage <span class="required">*</span></label>
          <textarea class="form-control" id="testiQuote" required placeholder="Texte du témoignage..."></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Jeu (optionnel)</label>
            <input class="form-control" id="testiGameTitle" placeholder="Ex: Jeu de Noël 2026">
          </div>
          <div class="form-group">
            <label>Rang (optionnel)</label>
            <input type="number" class="form-control" id="testiRank" min="1" max="10" placeholder="1">
          </div>
        </div>

        <div class="form-group">
          <label>Photo (optionnel)</label>
          <div class="file-upload" id="testiPhotoUpload">
            <i class="fas fa-camera"></i>
            <p>Uploader une photo (optionnel)</p>
            <input type="file" accept="image/*" id="testiPhotoInput" onchange="previewTestimonialPhoto(this)">
            <img class="file-preview" id="testiPhotoPreview" alt="">
          </div>
        </div>

        <div class="form-check">
          <input type="checkbox" id="testiActive" checked>
          <label for="testiActive">Actif</label>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('createTestimonialModal')">Annuler</button>
      <button class="btn btn-primary" onclick="createTestimonial()">
        <i class="fas fa-check"></i> Ajouter
      </button>
    </div>
  </div>
</div>

<!-- ========== GAME DETAILS MODAL ========== -->
<div class="modal-overlay" id="gameDetailsModal">
  <div class="modal large">
    <div class="modal-header">
      <h3><i class="fas fa-gamepad"></i> Détails du Jeu</h3>
      <button class="modal-close" onclick="closeModal('gameDetailsModal')">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body" id="gameDetailsBody">
      <!-- Dynamically populated -->
    </div>

    <div class="modal-footer" id="gameDetailsFooter">
      <button class="btn btn-outline" onclick="closeModal('gameDetailsModal')">Fermer</button>
    </div>
  </div>
</div>

<!-- ========== USER DETAILS MODAL ========== -->
<div class="modal-overlay" id="userDetailsModal">
    <div class="modal large">
      <div class="modal-header">
        <h3><i class="fas fa-user"></i> Détails Utilisateur</h3>
        <button class="modal-close" onclick="closeModal('userDetailsModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="userDetailsBody"></div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('userDetailsModal')">Fermer</button>
      </div>
    </div>
  </div>


    <!-- ========== FINALIZE GAME MODAL ========== -->
<div class="modal-overlay" id="finalizeGameModal">
    <div class="modal large">
      <div class="modal-header">
        <h3><i class="fas fa-archive"></i> Finaliser & Archiver le jeu</h3>
        <button class="modal-close" onclick="closeModal('finalizeGameModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
  
      <div class="modal-body">
        <div id="finalizeGameInfo" class="alert alert-info">
          <i class="fas fa-info-circle"></i> Chargement...
        </div>
  
        <div id="finalizeAwardsEditor"></div>
      </div>
  
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('finalizeGameModal')">Annuler</button>
        <button class="btn btn-secondary" onclick="saveAwardsAndArchive()">
          <i class="fas fa-check"></i> Enregistrer & Archiver
        </button>
      </div>
    </div>
  </div>

    <!-- ========== LOADING OVERLAY ========== -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p id="loadingText">Chargement...</p>
    </div>
    
    <!-- ========== TOAST CONTAINER ========== -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- ========== SCRIPTS ========== -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            SUPABASE_URL: 'https://ynymnvmilertakacfrhy.supabase.co',
            SUPABASE_ANON_KEY: 'sb_publishable_jbmKmsT4FxmiTfYUBajgOA_QxWz8j2K',
            CLOUDINARY_CLOUD_NAME: 'drvkea88c',
            CLOUDINARY_UPLOAD_PRESET: 'social_vote_uploads'
        };
        
        // Initialisation Supabase
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let adminUser = null;
        let allUsers = [];
        let allGames = [];
        let allCandidates = [];
        let allVotes = [];
        let allLogs = [];
        let allAds = [];
        let allSponsors = [];
        let prizePhotos = {};
        let adMediaFile = null;
        
        // Charts
        let activityChart = null;
        let votesDistributionChart = null;
        let financialChart = null;
        
        // ============================================
        // INITIALISATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            initSidebar();
            initNavigation();
            updateHeaderTime();
            
            // Check admin auth
            await checkAdminAuth();
            
            // Start game status checker
            setInterval(checkGameStatuses, 60000); // Check every minute
        });
        
        // ============================================
        // AUTHENTICATION
        // ============================================
        async function checkAdminAuth() {
            try {
                const session = localStorage.getItem('socialvote_session');
                if (!session) {
                    window.location.href = '..//auth/';
                    return;
                }
                
                adminUser = JSON.parse(session);
                
                // Verify admin role
                const { data: user, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', adminUser.id)
                    .eq('role', 'admin')
                    .single();
                
                if (error || !user) {
                    localStorage.removeItem('socialvote_session');
                    window.location.href = '..//auth/';
                    return;
                }
                
                adminUser = user;
                
                // Update header
                document.getElementById('adminPhoto').src = adminUser.photo_url || 'https://placehold.co/40x40?text=A';
                document.getElementById('adminName').textContent = adminUser.full_name;
                
                // Load dashboard
                await loadDashboard();
                
            } catch (error) {
                console.error('Auth error:', error);
                window.location.href = '..//auth/';
            }
        }
        
        function logout() {
            localStorage.removeItem('socialvote_session');
            window.location.href = '../index.html';
        }
        
        // ============================================
        // SIDEBAR & NAVIGATION
        // ============================================
        function initSidebar() {
            const toggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            toggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });
            
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        }
        
        function initNavigation() {
            const menuItems = document.querySelectorAll('.menu-item[data-section]');
            
            menuItems.forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.dataset.section;
                    navigateTo(section);
                });
            });
            
            // Init tabs
            document.querySelectorAll('.tabs').forEach(tabContainer => {
                const buttons = tabContainer.querySelectorAll('.tab-btn');
                buttons.forEach(btn => {
                    btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const tab = btn.dataset.tab;

                    // Si on est dans la section Parrainage, on rend directement
                    const activeSection = document.querySelector('.content-section.active')?.id || '';
                    if (activeSection === 'referralsSection' && window.__referrersComputed) {
                        renderReferrersTabs(tab);
                        return;
                    }

                    // Sinon comportement normal
                    loadTabContent(tab);
                    });
                });
                });
        }
        
        function navigateTo(section) {
            // Update menu
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.toggle('active', item.dataset.section === section);
            });
            
            // Update sections
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(section + 'Section').classList.add('active');
            
            // Update title
            const titles = {
                dashboard: 'Dashboard',
                users: 'Utilisateurs',
                games: 'Jeux',
                candidates: 'Candidatures',
                votes: 'Votes',
                referrals: 'Parrainage',
                finances: 'Finances',
                ads: 'Publicités',
                sponsors: 'Sponsors',
                testimonials: 'Témoignages',
                settings: 'Paramètres',
                logs: 'Logs'
            };
            document.getElementById('pageTitle').textContent = titles[section] || 'Dashboard';
            
            // Load section data
            loadSectionData(section);
            
            // Close sidebar on mobile
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }
        
        async function loadSectionData(section) {
            switch (section) {
                case 'dashboard':
                    await loadDashboard();
                    break;
                case 'users':
                    await loadUsers();
                    break;
                case 'games':
                    await loadGames();
                    break;
                case 'candidates':
                    await loadCandidates();
                    break;
                case 'votes':
                    await loadVotes();
                    break;
                case 'referrals':
                    await loadReferrals();
                    break;
                case 'finances':
                    await loadFinances();
                    break;
                case 'ads':
                    await loadAdStats(); // Charge les stats (nouveau)
                    await loadAds();
                    break;
                case 'sponsors':
                    await loadSponsors();
                    break;
                case 'testimonials':
                    await loadTestimonials();
                    break;
                case 'logs':
                    await loadLogs();
                    break;
            }
        }
        
        function renderReferrersTabs(tab) {
            const data = window.__referrersComputed || [];
            const container = document.getElementById('referralsContent');

            let list = data;

            if (tab === 'eligibleReferrers') {
                list = data.filter(x => x.eligible && x.payment_status === 'pending');
            } else if (tab === 'paidReferrers') {
                list = data.filter(x => x.payment_status === 'paid');
            } else if (tab === 'allReferrers') {
                list = data.filter(x => x.count > 0);
            }

            if (list.length === 0) {
                container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-user-friends"></i>
                    <h4>Aucune donnée</h4>
                    <p>Rien à afficher dans cet onglet.</p>
                </div>
                `;
                return;
            }

            container.innerHTML = list
                .sort((a,b) => (b.count - a.count))
                .map(x => {
                const u = x.user || {};
                const p = x.prof || {};
                const gtitle = x.game?.title || 'Jeu';
                const status = x.payment_status;

                const wa = (u.whatsapp_number || '').replace(/[^0-9]/g,'');
                const waLink = wa
                    ? `https://wa.me/${wa}?text=${encodeURIComponent(
                        `Bonjour ${u.full_name || ''}.\nPrime parrainage: ${x.bonusAmount} FCFA\nJeu: ${gtitle}\nStatut: ${status}\nMobile Money: ${u.mobile_money_type || ''} ${u.mobile_money_number || ''}\n`
                    )}`
                    : null;

                return `
                    <div class="referral-payment-card">
                    <div class="referral-user-info">
                        <img src="${u.photo_url || ''}" onerror="this.style.display='none'">
                        <div class="details">
                        <h5>${escapeHtml(u.full_name || p.username || 'Candidat')}</h5>
                        <p>${escapeHtml(gtitle)} • Code: <code>${escapeHtml(p.referral_code || '')}</code></p>
                        <p style="font-size:.8rem;color:var(--gray);">
                            WhatsApp: ${escapeHtml(u.whatsapp_number || 'N/A')} • MoMo: ${escapeHtml(u.mobile_money_type || '')} ${escapeHtml(u.mobile_money_number || '')}
                        </p>
                        </div>
                    </div>

                    <div class="referral-stats">
                        <div class="referral-stat">
                        <span class="value">${x.count}</span>
                        <span class="label">Filleuls</span>
                        </div>
                        <div class="referral-stat">
                        <span class="value" style="color:var(--accent);">${(x.bonusAmount || 0).toLocaleString()} F</span>
                        <span class="label">Prime</span>
                        </div>
                    </div>

                    <div class="referral-actions">
                        <span class="badge ${status === 'paid' ? 'badge-success' : 'badge-warning'}">
                        ${status === 'paid' ? 'Payé' : 'En attente'}
                        </span>

                        ${status !== 'paid' ? `
                        <button class="btn btn-success btn-sm" onclick="upsertAndMarkPaid('${x.referrer_id}','${x.game_id}',${x.count},${x.bonusAmount})">
                            <i class="fas fa-check"></i> Payer
                        </button>
                        ` : ''}

                        ${waLink ? `
                        <a class="btn btn-primary btn-sm" target="_blank" href="${waLink}">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                        ` : ''}
                    </div>
                    </div>
                `;
                })
                .join('');
            }

            async function upsertAndMarkPaid(referrerId, gameId, referralCount, bonusAmount) {
                if (!confirm('Confirmer le paiement ?')) return;

                showLoading('Validation paiement...');
                try {
                    // upsert payment row then mark paid
                    const { data: existing } = await supabaseClient
                    .from('referral_payments')
                    .select('id')
                    .eq('referrer_id', referrerId)
                    .eq('game_id', gameId)
                    .maybeSingle();

                    if (existing?.id) {
                    await supabaseClient
                        .from('referral_payments')
                        .update({
                        referral_count: referralCount,
                        bonus_amount: bonusAmount,
                        payment_status: 'paid',
                        paid_at: new Date().toISOString()
                        })
                        .eq('id', existing.id);
                    } else {
                    await supabaseClient
                        .from('referral_payments')
                        .insert([{
                        referrer_id: referrerId,
                        game_id: gameId,
                        referral_count: referralCount,
                        bonus_amount: bonusAmount,
                        payment_status: 'paid',
                        paid_at: new Date().toISOString()
                        }]);
                    }

                    await logAdminActivity('pay_referral', `Prime payée: ${bonusAmount}F`);

                    showToast('Paiement confirmé', 'success');
                    await loadReferrals();
                } catch (e) {
                    console.error(e);
                    showToast("Erreur paiement", "error");
                } finally {
                    hideLoading();
                }
                }

        function loadTabContent(tab) {
            // Determine which section is currently active
            const activeSection = document.querySelector('.content-section.active')?.id || '';

            // GAMES tabs
            if (activeSection === 'gamesSection') {
                if (!allGames) return;
                if (tab === 'allGames') return renderGames(allGames);
                if (tab === 'activeGames') return renderGames(allGames.filter(g => g.status === 'active'));
                if (tab === 'pendingGames') return renderGames(allGames.filter(g => g.status === 'pending'));
                if (tab === 'endedGames') return renderGames(allGames.filter(g => g.status === 'ended'));
                if (tab === 'archivedGames') return renderGames(allGames.filter(g => g.status === 'archived'));
            }

            // CANDIDATES tabs
            if (activeSection === 'candidatesSection') {
                if (!allCandidates) return;
                if (tab === 'pendingCandidates') return renderCandidates(allCandidates.filter(c => c.status === 'pending'), 'pending');
                if (tab === 'approvedCandidates') return renderCandidates(allCandidates.filter(c => c.status === 'approved'), 'approved');
                if (tab === 'rejectedCandidates') return renderCandidates(allCandidates.filter(c => c.status === 'rejected'), 'rejected');
            }

            // ADS tabs (optional filtering)
            if (activeSection === 'adsSection') {
                if (!allAds) return;
                if (tab === 'homepageAds') return renderAds(allAds.filter(a => a.position === 'homepage_carousel'));
                if (tab === 'popupAds') return renderAds(allAds.filter(a => a.position === 'vote_popup'));
                if (tab === 'voteAds') return renderAds(allAds.filter(a => a.position === 'vote_before'));
            }

            // REFERRALS tabs (we'll implement renderReferrersTabs later)
            if (activeSection === 'referralsSection') {
                if (window.__referrersComputed) {
                return renderReferrersTabs(tab);
                }
            }
            }
        
        function updateHeaderTime() {
            const updateTime = () => {
                const now = new Date();
                document.getElementById('headerTime').textContent = now.toLocaleString('fr-FR', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };
            updateTime();
            setInterval(updateTime, 60000);
        }
        
        // ============================================
        // DASHBOARD
        // ============================================
        async function loadDashboard() {
            showLoading('Chargement du dashboard...');
            
            try {
                // Load stats
                const [usersCount, candidatesCount, gamesCount, votesData] = await Promise.all([
                    supabaseClient.from('users').select('*', { count: 'exact', head: true }),
                    supabaseClient.from('game_entries').select('*', { count: 'exact', head: true }).eq('status', 'approved'),
                    supabaseClient.from('games').select('*', { count: 'exact', head: true }),
                    supabaseClient.from('votes').select('vote_count')
                ]);
                
                const totalVotes = votesData.data?.reduce((sum, v) => sum + (v.vote_count || 1), 0) || 0;
                
                // Pending candidates
                const { count: pendingCount } = await supabaseClient
                    .from('game_entries')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'pending');
                
                document.getElementById('pendingCandidatesCount').textContent = pendingCount || 0;
                
                // Revenue today
                const startOfDay = new Date();
                startOfDay.setHours(0,0,0,0);

                const { data: todayPaidVotes } = await supabaseClient
                .from('votes')
                .select('amount_paid')
                .eq('vote_type', 'paid')
                .gte('voted_at', startOfDay.toISOString());

                const todayVoteRevenue = todayPaidVotes?.reduce((sum, v) => sum + (v.amount_paid || 0), 0) || 0;

                // revenus inscriptions du jour = nb candidatures approuvées aujourd’hui * registration_fee du jeu correspondant
                // Comme registration_fee dépend du jeu, on calcule en joignant games
                const { data: todayApprovedEntries } = await supabaseClient
                .from('game_entries')
                .select('approved_at, game_id, status, games:game_id(registration_fee)')
                .eq('status', 'approved')
                .gte('approved_at', startOfDay.toISOString());

                const todayRegistrationRevenue = (todayApprovedEntries || [])
                .reduce((sum, e) => sum + (Number(e.games?.registration_fee) || 0), 0);

                const todayRevenue = todayVoteRevenue + todayRegistrationRevenue;

                document.getElementById('dashboardStats').innerHTML = `
                    <div class="stat-card">
                        <div class="icon blue"><i class="fas fa-users"></i></div>
                        <div class="info">
                            <h4>${usersCount.count || 0}</h4>
                            <p>Utilisateurs</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon green"><i class="fas fa-user-check"></i></div>
                        <div class="info">
                            <h4>${candidatesCount.count || 0}</h4>
                            <p>Candidats Actifs</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon gold"><i class="fas fa-vote-yea"></i></div>
                        <div class="info">
                            <h4>${totalVotes.toLocaleString()}</h4>
                            <p>Votes Totaux</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon purple"><i class="fas fa-gamepad"></i></div>
                        <div class="info">
                            <h4>${gamesCount.count || 0}</h4>
                            <p>Jeux Créés</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon red"><i class="fas fa-clock"></i></div>
                        <div class="info">
                            <h4>${pendingCount || 0}</h4>
                            <p>Candidatures en attente</p>
                        </div>
                    </div>
                    <div class="stat-card">
                    <div class="icon green"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="info">
                        <h4>${todayRevenue.toLocaleString()} F</h4>
                        <p>Revenus aujourd'hui</p>
                        <div class="trend up">
                        Inscriptions: ${todayRegistrationRevenue.toLocaleString()}F • Votes: ${todayVoteRevenue.toLocaleString()}F
                        </div>
                    </div>
                    </div>
                `;
                
                // Load current game status
                await loadCurrentGameStatus();
                
                // Load charts
                await loadActivityChart();
                await loadVotesDistributionChart();
                
                // Load recent activity
                await loadRecentActivity();
                
            } catch (error) {
                console.error('Dashboard error:', error);
                showToast('Erreur de chargement du dashboard', 'error');
            }
            
            hideLoading();
        }
        
        async function loadCurrentGameStatus() {
            const { data: games } = await supabaseClient
                .from('games')
                .select('*')
                .in('status', ['active', 'pending'])
                .order('created_at', { ascending: false })
                .limit(1);
            
            const container = document.getElementById('currentGameStatus');
            
            if (games && games.length > 0) {
                const game = games[0];
                const statusConfig = {
                    active: { class: 'active', icon: 'play-circle', text: 'En cours' },
                    pending: { class: 'pending', icon: 'clock', text: 'En attente' }
                };
                const status = statusConfig[game.status];
                
                container.innerHTML = `
                    <div class="game-status-card">
                        <div class="game-status-info">
                            <div class="icon ${status.class}">
                                <i class="fas fa-${status.icon}"></i>
                            </div>
                            <div class="details">
                                <h4>${game.title}</h4>
                                <p>
                                    <i class="fas fa-calendar"></i> ${formatDateTime(game.start_time)} - ${formatDateTime(game.end_time)}
                                </p>
                            </div>
                        </div>
                        <div class="btn-group">
                            <span class="badge badge-${game.status === 'active' ? 'success' : 'warning'}">
                                ${status.text}
                            </span>
                            ${game.status === 'active' ? `
                                <button class="btn btn-danger btn-sm" onclick="endGame('${game.id}')">
                                    <i class="fas fa-stop"></i> Terminer
                                </button>
                            ` : ''}
                            ${game.status === 'pending' ? `
                                <button class="btn btn-success btn-sm" onclick="startGame('${game.id}')">
                                    <i class="fas fa-play"></i> Démarrer
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Aucun jeu actif ou en attente. 
                        <a href="#" onclick="navigateTo('games'); openCreateGameModal();" style="color: var(--info); text-decoration: underline;">Créer un nouveau jeu</a>
                    </div>
                `;
            }
        }
        
        async function loadActivityChart() {
            const ctx = document.getElementById('activityChart');
            if (!ctx) return;
            
            // Get last 30 days data
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const { data: votes } = await supabaseClient
                .from('votes')
                .select('voted_at, vote_count')
                .gte('voted_at', thirtyDaysAgo.toISOString());
            
            // Group by day
            const dailyData = {};
            for (let i = 0; i < 30; i++) {
                const date = new Date();
                date.setDate(date.getDate() - (29 - i));
                dailyData[date.toISOString().split('T')[0]] = 0;
            }
            
            votes?.forEach(vote => {
                const date = vote.voted_at.split('T')[0];
                if (dailyData[date] !== undefined) {
                    dailyData[date] += vote.vote_count || 1;
                }
            });
            
            const labels = Object.keys(dailyData).map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
            });
            const data = Object.values(dailyData);
            
            if (activityChart) activityChart.destroy();
            
            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Votes',
                        data: data,
                        borderColor: 'rgba(212, 175, 55, 1)',
                        backgroundColor: 'rgba(212, 175, 55, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        async function loadVotesDistributionChart() {
            const ctx = document.getElementById('votesDistributionChart');
            if (!ctx) return;
            
            const { data: votes } = await supabaseClient
                .from('votes')
                .select('vote_type, vote_count');
            
            const distribution = { free: 0, paid: 0, bonus: 0 };
            votes?.forEach(vote => {
                distribution[vote.vote_type] = (distribution[vote.vote_type] || 0) + (vote.vote_count || 1);
            });
            
            if (votesDistributionChart) votesDistributionChart.destroy();
            
            votesDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Gratuits', 'Payants', 'Bonus'],
                    datasets: [{
                        data: [distribution.free, distribution.paid, distribution.bonus],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(23, 162, 184, 0.8)',
                            'rgba(212, 175, 55, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        async function loadRecentActivity() {
            const { data: logs } = await supabaseClient
                .from('activity_logs')
                .select('*, users(full_name, photo_url)')
                .order('created_at', { ascending: false })
                .limit(10);
            
            const container = document.getElementById('recentActivity');
            
            if (!logs || logs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <p>Aucune activité récente</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = logs.map(log => `
                <div style="display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid #e0e0e0;">
                    <img src="${log.users?.photo_url || 'https://via.placeholder.com/40?text=U'}" 
                         alt="" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                    <div style="flex: 1;">
                        <p style="font-weight: 600; color: var(--primary); margin-bottom: 3px;">
                            ${log.users?.full_name || 'Système'}
                        </p>
                        <p style="font-size: 0.85rem; color: var(--gray);">${log.description}</p>
                    </div>
                    <span style="font-size: 0.8rem; color: var(--gray);">
                        ${formatTimeAgo(log.created_at)}
                    </span>
                </div>
            `).join('');
        }
        
        // ============================================
        // GAMES MANAGEMENT
        // ============================================
        async function loadGames() {
            showLoading('Chargement des jeux...');
            
            try {
                const { data: games, error } = await supabaseClient
                    .from('games')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allGames = games || [];
                
                // Load candidates count for each game
                for (let game of allGames) {
                    const { count } = await supabaseClient
                        .from('game_entries')
                        .select('*', { count: 'exact', head: true })
                        .eq('game_id', game.id)
                        .eq('status', 'approved');
                    game.candidatesCount = count || 0;
                    
                    // Load total votes
                    const { data: entries } = await supabaseClient
                        .from('game_entries')
                        .select('total_votes')
                        .eq('game_id', game.id);
                    game.totalVotes = entries?.reduce((sum, e) => sum + (e.total_votes || 0), 0) || 0;
                }
                
                renderGames(allGames);
                
            } catch (error) {
                console.error('Games error:', error);
                showToast('Erreur de chargement des jeux', 'error');
            }
            
            hideLoading();
        }
        
        function renderGames(games) {
            const container = document.getElementById('gamesContent');
            
            if (games.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-gamepad"></i>
                        <h4>Aucun jeu</h4>
                        <p>Créez votre premier jeu pour commencer</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = games.map(game => {
                const statusConfig = {
                    draft: { class: 'primary', text: 'Brouillon', icon: 'edit' },
                    pending: { class: 'warning', text: 'En attente', icon: 'clock' },
                    active: { class: 'success', text: 'Actif', icon: 'play-circle' },
                    ended: { class: 'info', text: 'Terminé', icon: 'flag-checkered' },
                    archived: { class: 'secondary', text: 'Archivé', icon: 'archive' }
                };
                const status = statusConfig[game.status] || statusConfig.draft;
                
                return `
                    <div class="game-status-card" style="flex-direction: column; align-items: stretch;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div class="game-status-info">
                                <div class="icon ${game.status === 'active' ? 'active' : game.status === 'pending' ? 'pending' : 'ended'}">
                                    <i class="fas fa-${status.icon}"></i>
                                </div>
                                <div class="details">
                                    <h4>${game.title}</h4>
                                    <p>
                                        <i class="fas fa-calendar"></i> ${formatDateTime(game.start_time)} - ${formatDateTime(game.end_time)}
                                    </p>
                                </div>
                            </div>
                            <span class="badge badge-${status.class}">
                                <i class="fas fa-${status.icon}"></i> ${status.text}
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; margin: 20px 0; padding: 15px; background: var(--light-bg); border-radius: 10px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${game.candidatesCount}</div>
                                <div style="font-size: 0.8rem; color: var(--gray);">Candidats</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${game.totalVotes}</div>
                                <div style="font-size: 0.8rem; color: var(--gray);">Votes</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${game.registration_fee} F</div>
                                <div style="font-size: 0.8rem; color: var(--gray);">Inscription</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${game.vote_price} F</div>
                                <div style="font-size: 0.8rem; color: var(--gray);">Prix vote</div>
                            </div>
                        </div>
                        
                        <div class="btn-group" style="justify-content: flex-end;">
                            <button class="btn btn-outline btn-sm" onclick="viewGameDetails('${game.id}')">
                                <i class="fas fa-eye"></i> Détails
                            </button>
                            ${game.status === 'pending' ? `
                                <button class="btn btn-success btn-sm" onclick="startGame('${game.id}')">
                                    <i class="fas fa-play"></i> Démarrer
                                </button>
                            ` : ''}
                            ${game.status === 'active' ? `
                                <button class="btn btn-danger btn-sm" onclick="endGame('${game.id}')">
                                    <i class="fas fa-stop"></i> Terminer
                                </button>
                            ` : ''}
                            ${game.status === 'ended' ? `
                                <button class="btn btn-secondary btn-sm" onclick="openFinalizeGameModal('${game.id}')">
                                    <i class="fas fa-archive"></i> Finaliser & Archiver
                                </button>
                                ` : ''}
                            ${game.status === 'draft' || game.status === 'pending' ? `
                                <button class="btn btn-danger btn-sm" onclick="deleteGame('${game.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function openCreateGameModal() {
            document.getElementById('createGameForm').reset();
            prizePhotos = {};
            updatePrizesEditor();
            openModal('createGameModal');
        }
        
        function updatePrizesEditor() {
            const count = parseInt(document.getElementById('gameWinnersCount').value) || 3;
            const container = document.getElementById('prizesEditor');
            
            const positions = ['1er', '2ème', '3ème', '4ème', '5ème', '6ème', '7ème', '8ème', '9ème', '10ème'];
            
            container.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                container.innerHTML += `
                    <div class="prize-card-editor">
                        <span class="position">${positions[i]} Prix</span>
                        <div class="prize-row">
                            <div class="prize-photo-upload" onclick="document.getElementById('prizePhoto${i}').click()">
                                <img src="" alt="" id="prizePhotoPreview${i}" style="display: none;">
                                <i class="fas fa-camera" id="prizePhotoIcon${i}" style="font-size: 2rem; color: var(--gray);"></i>
                                <input type="file" id="prizePhoto${i}" accept="image/*" style="display: none;" onchange="previewPrizePhoto(${i}, this)">
                            </div>
                            <div style="flex: 1;">
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label>Titre du prix</label>
                                    <input type="text" class="form-control" id="prizeTitle${i}" placeholder="Ex: iPhone 15 Pro">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Description</label>
                                    <input type="text" class="form-control" id="prizeDescription${i}" placeholder="Description courte...">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function previewPrizePhoto(index, input) {
            const file = input.files[0];
            if (!file) return;
            
            prizePhotos[index] = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById(`prizePhotoPreview${index}`);
                const icon = document.getElementById(`prizePhotoIcon${index}`);
                preview.src = e.target.result;
                preview.style.display = 'block';
                icon.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        async function createGame() {
            const title = document.getElementById('gameTitle').value.trim();
            const description = document.getElementById('gameDescription').value.trim();
            const startTime = document.getElementById('gameStartTime').value;
            const endTime = document.getElementById('gameEndTime').value;
            const winnersCount = parseInt(document.getElementById('gameWinnersCount').value);
            const registrationFee = parseFloat(document.getElementById('gameRegistrationFee').value);
            const votePrice = parseFloat(document.getElementById('gameVotePrice').value);

            if (!title || !startTime || !endTime) return showToast('Champs requis manquants', 'error');

            showLoading('Création sécurisée...');

            try {
                // Préparer les prix
                const prizes = [];
                for (let i = 0; i < winnersCount; i++) {
                const pTitle = document.getElementById(`prizeTitle${i}`)?.value?.trim();
                if (pTitle) {
                    let photoUrl = null;
                    if (prizePhotos[i]) photoUrl = await uploadToCloudinary(prizePhotos[i], 'prizes');
                    prizes.push({
                    position: i + 1,
                    title: pTitle,
                    description: document.getElementById(`prizeDescription${i}`)?.value?.trim(),
                    photo_url: photoUrl
                    });
                }
                }

                // Appel RPC sécurisé
                const { data: gameId, error } = await supabaseClient.rpc('admin_create_game', {
                p_admin_id: adminUser.id,
                p_title: title,
                p_description: description,
                p_start_time: startTime,
                p_end_time: endTime,
                p_winners_count: winnersCount,
                p_registration_fee: registrationFee,
                p_vote_price: votePrice,
                p_prizes: prizes
                });

                if (error) throw error;

                await logAdminActivity('create_game', `Jeu créé (RPC): ${title}`);
                closeModal('createGameModal');
                showToast('Jeu créé avec succès !', 'success');
                await loadGames();

            } catch (e) {
                console.error(e);
                showToast("Erreur création : " + e.message, "error");
            } finally {
                hideLoading();
            }
        }
        
        async function startGame(gameId) {
            if (!confirm('Êtes-vous sûr de vouloir démarrer ce jeu maintenant ?')) return;
            
            showLoading('Démarrage du jeu...');
            
            try {
                await supabaseClient
                    .from('games')
                    .update({ status: 'active' })
                    .eq('id', gameId);
                
                await logAdminActivity('start_game', `Jeu démarré manuellement`);
                
                showToast('Jeu démarré !', 'success');
                await loadGames();
                await loadCurrentGameStatus();
                
            } catch (error) {
                console.error('Start game error:', error);
                showToast('Erreur lors du démarrage', 'error');
            }
            
            hideLoading();
        }
        
        async function endGame(gameId) {
            if (!confirm('Êtes-vous sûr de vouloir terminer ce jeu maintenant ?')) return;
            
            showLoading('Fin du jeu...');
            
            try {
                // Calculate final rankings
                const { data: entries } = await supabaseClient
                    .from('game_entries')
                    .select('*')
                    .eq('game_id', gameId)
                    .eq('status', 'approved')
                    .order('total_votes', { ascending: false });
                
                // Update ranks
                for (let i = 0; i < entries.length; i++) {
                    await supabaseClient
                        .from('game_entries')
                        .update({ rank: i + 1 })
                        .eq('id', entries[i].id);
                }
                
                // Update game status
                await supabaseClient
                    .from('games')
                    .update({ status: 'ended' })
                    .eq('id', gameId);
                
                // Calculate referral payments
                await calculateReferralPayments(gameId);
                
                await logAdminActivity('end_game', `Jeu terminé manuellement`);
                
                showToast('Jeu terminé ! Les résultats sont calculés.', 'success');
                await loadGames();
                await loadCurrentGameStatus();
                
            } catch (error) {
                console.error('End game error:', error);
                showToast('Erreur lors de la fin du jeu', 'error');
            }
            
            hideLoading();
        }
        
        async function archiveGame(gameId) {
            if (!confirm('Êtes-vous sûr de vouloir archiver ce jeu ?')) return;
            
            showLoading('Archivage...');
            
            try {
                await supabaseClient
                    .from('games')
                    .update({ status: 'archived' })
                    .eq('id', gameId);
                
                await logAdminActivity('archive_game', `Jeu archivé`);
                
                showToast('Jeu archivé !', 'success');
                await loadGames();
                
            } catch (error) {
                console.error('Archive game error:', error);
                showToast('Erreur lors de l\'archivage', 'error');
            }
            
            hideLoading();
        }
        
        async function deleteGame(gameId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce jeu ? Cette action est irréversible.')) return;
            
            showLoading('Suppression...');
            
            try {
                await supabaseClient.from('game_prizes').delete().eq('game_id', gameId);
                await supabaseClient.from('game_entries').delete().eq('game_id', gameId);
                await supabaseClient.from('games').delete().eq('id', gameId);
                
                await logAdminActivity('delete_game', `Jeu supprimé`);
                
                showToast('Jeu supprimé !', 'success');
                await loadGames();
                
            } catch (error) {
                console.error('Delete game error:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
            
            hideLoading();
        }
        
        // Check game statuses automatically
        async function checkGameStatuses() {
            const now = new Date().toISOString();
            
            try {
                // Start pending games
                const { data: toStart } = await supabaseClient
                    .from('games')
                    .select('id, title')
                    .eq('status', 'pending')
                    .lte('start_time', now);
                
                for (let game of (toStart || [])) {
                    await supabaseClient
                        .from('games')
                        .update({ status: 'active' })
                        .eq('id', game.id);
                    
                    await logAdminActivity('auto_start_game', `Jeu démarré automatiquement: ${game.title}`);
                    console.log(`Game started automatically: ${game.title}`);
                }
                
                // End active games
                const { data: toEnd } = await supabaseClient
                    .from('games')
                    .select('id, title')
                    .eq('status', 'active')
                    .lte('end_time', now);
                
                for (let game of (toEnd || [])) {
                    // Calculate rankings
                    const { data: entries } = await supabaseClient
                        .from('game_entries')
                        .select('*')
                        .eq('game_id', game.id)
                        .eq('status', 'approved')
                        .order('total_votes', { ascending: false });
                    
                    for (let i = 0; i < (entries || []).length; i++) {
                        await supabaseClient
                            .from('game_entries')
                            .update({ rank: i + 1 })
                            .eq('id', entries[i].id);
                    }
                    
                    await supabaseClient
                        .from('games')
                        .update({ status: 'ended' })
                        .eq('id', game.id);
                    
                    await calculateReferralPayments(game.id);
                    
                    await logAdminActivity('auto_end_game', `Jeu terminé automatiquement: ${game.title}`);
                    console.log(`Game ended automatically: ${game.title}`);
                }
                
                // Refresh if any changes
                if ((toStart && toStart.length > 0) || (toEnd && toEnd.length > 0)) {
                    await loadCurrentGameStatus();
                }
                
            } catch (error) {
                console.error('Check game status error:', error);
            }
        }
        
        // ============================================
        // CANDIDATES MANAGEMENT
        // ============================================
        async function loadCandidates() {
            showLoading('Chargement des candidatures...');
            
            try {
                const { data: candidates, error } = await supabaseClient
                    .from('game_entries')
                    .select(`
                        *,
                        users:user_id (full_name, email, phone, photo_url, whatsapp_number, mobile_money_number, mobile_money_type),
                        games:game_id (title, status),
                        candidate_profiles:candidate_id (username, referral_code)
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allCandidates = candidates || [];
                
                renderCandidates(allCandidates.filter(c => c.status === 'pending'), 'pending');
                
            } catch (error) {
                console.error('Candidates error:', error);
                showToast('Erreur de chargement des candidatures', 'error');
            }
            
            hideLoading();
        }
        
        function renderCandidates(candidates, type) {
            const container = document.getElementById('candidatesContent');
            
            if (candidates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-check"></i>
                        <h4>Aucune candidature ${type === 'pending' ? 'en attente' : ''}</h4>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Candidat</th>
                                <th>Jeu</th>
                                <th>Numéro</th>
                                <th>Parrain</th>
                                <th>Date</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${candidates.map(c => `
                                <tr>
                                    <td>
                                        <div class="table-user">
                                            <img src="${c.users?.photo_url || 'https://via.placeholder.com/40?text=U'}" alt="">
                                            <div>
                                                <span class="name">${c.users?.full_name || 'N/A'}</span>
                                                <span class="email">${c.users?.email || ''}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>${c.games?.title || 'N/A'}</td>
                                    <td><code>${c.candidate_number}</code></td>
                                    <td>${c.referred_by || '-'}</td>
                                    <td>${formatDate(c.created_at)}</td>
                                    <td>
                                        <span class="badge badge-${c.status === 'approved' ? 'success' : c.status === 'rejected' ? 'danger' : 'warning'}">
                                            ${c.status === 'approved' ? 'Approuvé' : c.status === 'rejected' ? 'Rejeté' : 'En attente'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-outline btn-sm" onclick="viewCandidate('${c.id}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            ${c.status === 'pending' ? `
                                                <button class="btn btn-success btn-sm" onclick="approveCandidate('${c.id}')">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm" onclick="rejectCandidate('${c.id}')">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        async function viewCandidate(entryId) {
            const candidate = allCandidates.find(c => c.id === entryId);
            if (!candidate) return;
            
            const details = document.getElementById('candidateDetails');
            const actions = document.getElementById('candidateActions');
            
            details.innerHTML = `
                <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid #e0e0e0;">
                    <img src="${candidate.users?.photo_url || 'https://via.placeholder.com/100?text=Photo'}" 
                         alt="" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent);">
                    <div>
                        <h4 style="color: var(--primary); margin-bottom: 5px;">${candidate.users?.full_name || 'N/A'}</h4>
                        <p style="color: var(--gray);">${candidate.users?.email}</p>
                        <span class="badge badge-${candidate.status === 'approved' ? 'success' : candidate.status === 'rejected' ? 'danger' : 'warning'}">
                            ${candidate.status === 'approved' ? 'Approuvé' : candidate.status === 'rejected' ? 'Rejeté' : 'En attente'}
                        </span>
                    </div>
                </div>
                
                <div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                    <div><strong>Téléphone:</strong> ${candidate.users?.phone || 'N/A'}</div>
                    <div><strong>WhatsApp:</strong> ${candidate.users?.whatsapp_number || 'N/A'}</div>
                    <div><strong>Mobile Money:</strong> ${candidate.users?.mobile_money_number || 'N/A'}</div>
                    <div><strong>Type:</strong> ${candidate.users?.mobile_money_type || 'N/A'}</div>
                    <div><strong>Numéro candidat:</strong> <code>${candidate.candidate_number}</code></div>
                    <div><strong>Code parrainage:</strong> <code>${candidate.candidate_profiles?.referral_code || 'N/A'}</code></div>
                    <div><strong>Parrainé par:</strong> ${candidate.referred_by || 'Aucun'}</div>
                    <div><strong>Jeu:</strong> ${candidate.games?.title}</div>
                </div>
                
                ${candidate.payment_proof_url ? `
                    <div style="margin-bottom: 20px;">
                        <strong>Preuve de paiement:</strong>
                        <div style="margin-top: 10px;">
                            <img src="${candidate.payment_proof_url}" alt="Preuve de paiement" 
                                 style="max-width: 100%; max-height: 300px; border-radius: 10px; border: 1px solid #e0e0e0;">
                        </div>
                    </div>
                ` : ''}
            `;
            
            actions.innerHTML = `
                <button class="btn btn-outline" onclick="closeModal('viewCandidateModal')">Fermer</button>
                ${candidate.status === 'pending' ? `
                    <button class="btn btn-danger" onclick="rejectCandidate('${candidate.id}'); closeModal('viewCandidateModal');">
                        <i class="fas fa-times"></i> Rejeter
                    </button>
                    <button class="btn btn-success" onclick="approveCandidate('${candidate.id}'); closeModal('viewCandidateModal');">
                        <i class="fas fa-check"></i> Approuver
                    </button>
                ` : ''}
            `;
            
            openModal('viewCandidateModal');
        }
        
        // ============================================
        // APPROVE CANDIDATE (RPC SECURE)
        // ============================================
       
async function approveCandidate(entryId) {
  showLoading('Approbation...');

  try {
    // 1) Approuver via RPC
    const { error: rpcErr } = await supabaseClient.rpc('admin_approve_candidate', {
      p_admin_id: adminUser.id,
      p_entry_id: entryId
    });

    if (rpcErr) throw rpcErr;

    // 2) Appliquer bonus referral (ne bloque pas si erreur)
    try {
      await applyReferralBonusesOnApproval(entryId);
    } catch (e) {
      console.warn("Referral bonus apply failed:", e);
    }

    // 3) Update candidate stats (cache) - Version simplifiée sans erreur
    const approvedEntry = allCandidates.find(c => c.id === entryId);
    if (approvedEntry?.candidate_id) {
        // On fait une mise à jour simple sans RPC compliquée
        const { data: profile } = await supabaseClient
            .from('candidate_profiles')
            .select('total_games_played')
            .eq('id', approvedEntry.candidate_id)
            .single();
            
        if (profile) {
            await supabaseClient
                .from('candidate_profiles')
                .update({ total_games_played: (profile.total_games_played || 0) + 1 })
                .eq('id', approvedEntry.candidate_id);
        }
    }

    await logAdminActivity('approve_candidate', `Candidature approuvée (RPC): ${approvedEntry?.users?.full_name || ''}`);

    showToast('Candidature approuvée !', 'success');
    
    // 4) Rechargement complet
    await loadCandidates();

    // Update pending badge
    const pendingCount = allCandidates.filter(c => c.status === 'pending').length;
    const badge = document.getElementById('pendingCandidatesCount');
    if (badge) badge.textContent = pendingCount;

  } catch (error) {
    console.error('Approve error:', error);
    showToast("Erreur lors de l'approbation: " + (error.message || ''), 'error');
  } finally {
    hideLoading();
  }
}

// ============================================
// APPLY REFERRAL BONUSES (CORRIGÉE & ROBUSTE)
// ============================================

async function applyReferralBonusesOnApproval(entryId) {
  console.log(`[BONUS] Traitement pour l'entrée : ${entryId}`);

  // 1. Récupérer les infos du filleul
  const { data: filleul, error: errFilleul } = await supabaseClient
    .from('game_entries')
    .select('id, game_id, candidate_id, referred_by, status')
    .eq('id', entryId)
    .single();

  if (errFilleul || !filleul) return; 
  
  const code = (filleul.referred_by || '').trim().toUpperCase();
  if (!code) return; 

  // 2. Trouver le profil du parrain
  const { data: parrainProfile } = await supabaseClient
    .from('candidate_profiles')
    .select('id')
    .eq('referral_code', code)
    .maybeSingle();

  if (!parrainProfile) return;

  // 3. Trouver l'entrée du parrain DANS LE MÊME JEU
  const { data: parrainEntry } = await supabaseClient
    .from('game_entries')
    .select('id')
    .eq('game_id', filleul.game_id)
    .eq('candidate_id', parrainProfile.id)
    .in('status', ['pending', 'approved'])
    .maybeSingle();

  if (!parrainEntry) return;

  // 4. Créer la liaison Referral
  await supabaseClient.from('referrals').upsert({
    referrer_id: parrainProfile.id,
    referee_id: filleul.candidate_id,
    game_id: filleul.game_id,
    bonus_votes_granted: 15,
    referee_bonus_votes: 10
  }, { onConflict: 'referee_id, game_id' });

  // 5. AJOUTER BONUS FILLEUL (+10)
  const { data: check10 } = await supabaseClient.from('votes')
    .select('id').eq('candidate_entry_id', filleul.id).eq('vote_type', 'bonus').eq('vote_count', 10).maybeSingle();

  if (!check10) {
    await supabaseClient.from('votes').insert({
      game_id: filleul.game_id,
      candidate_entry_id: filleul.id,
      vote_type: 'bonus',
      vote_count: 10,
      amount_paid: 0,
      voted_at: new Date().toISOString()
    });
  }

  // 6. AJOUTER BONUS PARRAIN (+15)
  // On insère simplement, l'index unique en base bloquera les doublons silencieusement (ou renverra une erreur qu'on ignore)
  const { error: err15 } = await supabaseClient.from('votes').insert({
    game_id: filleul.game_id,
    candidate_entry_id: parrainEntry.id,
    referee_entry_id: filleul.id,
    vote_type: 'bonus',
    vote_count: 15,
    amount_paid: 0,
    voted_at: new Date().toISOString()
  });
  
  if (err15 && err15.code !== '23505') {
      console.warn("Erreur insertion bonus parrain (non critique):", err15);
  }
}

        // ============================================
        // REJECT CANDIDATE (RPC SECURE)
        // ============================================
        async function rejectCandidate(entryId) {
        if (!confirm('Êtes-vous sûr de vouloir rejeter cette candidature ?')) return;

        showLoading('Rejet...');

        try {
            // Rejeter via RPC (vérifie admin)
            const { error: rpcErr } = await supabaseClient.rpc('admin_reject_candidate', {
            p_admin_id: adminUser.id,
            p_entry_id: entryId
            });

            if (rpcErr) throw rpcErr;

            await logAdminActivity('reject_candidate', `Candidature rejetée (RPC)`);

            showToast('Candidature rejetée', 'success');
            await loadCandidates();

        } catch (error) {
            console.error('Reject error:', error);
            showToast('Erreur lors du rejet', 'error');
        } finally {
            hideLoading();
        }
        }
        
        // ============================================
        // REFERRALS & PAYMENTS
        // ============================================
        async function loadReferrals() {
            showLoading('Chargement des parrainages...');

            try {
                // 1) Charger tous les referrals
                const { data: referrals, error: refErr } = await supabaseClient
                .from('referrals')
                .select(`
                    id, referrer_id, referee_id, game_id, bonus_votes_granted, created_at,
                    games:game_id (id, title, status)
                `);

                if (refErr) throw refErr;

                // 2) Charger paiements existants (pour statut paid/pending + paid_at)
                const { data: payments, error: payErr } = await supabaseClient
                .from('referral_payments')
                .select(`
                    id, referrer_id, game_id, referral_count, bonus_amount, payment_status, paid_at, created_at,
                    games:game_id (id, title)
                `);

                if (payErr) throw payErr;

                // 3) Construire map payments par (referrer_id, game_id)
                const payMap = new Map();
                (payments || []).forEach(p => payMap.set(`${p.referrer_id}_${p.game_id}`, p));

                // 4) Grouper referrals par (referrer_id, game_id)
                const grp = new Map();
                (referrals || []).forEach(r => {
                const key = `${r.referrer_id}_${r.game_id}`;
                if (!grp.has(key)) {
                    grp.set(key, { referrer_id: r.referrer_id, game: r.games, game_id: r.game_id, count: 0, bonusVotes: 0 });
                }
                const g = grp.get(key);
                g.count += 1;
                g.bonusVotes += (r.bonus_votes_granted || 0);
                });

                // 5) Charger infos referrers (users via candidate_profiles)
                const referrerIds = Array.from(new Set(Array.from(grp.values()).map(x => x.referrer_id)));
                const { data: refProfiles, error: profErr } = await supabaseClient
                .from('candidate_profiles')
                .select(`id, user_id, username, referral_code`)
                .in('id', referrerIds);

                if (profErr) throw profErr;

                const userIds = (refProfiles || []).map(p => p.user_id);
                const { data: users, error: userErr } = await supabaseClient
                .from('users')
                .select(`id, full_name, photo_url, whatsapp_number, mobile_money_number, mobile_money_type`)
                .in('id', userIds);

                if (userErr) throw userErr;

                const profileById = new Map((refProfiles || []).map(p => [p.id, p]));
                const userById = new Map((users || []).map(u => [u.id, u]));

                // 6) Construire liste finale
                const computed = Array.from(grp.values()).map(x => {
                const prof = profileById.get(x.referrer_id);
                const user = userById.get(prof?.user_id);
                const key = `${x.referrer_id}_${x.game_id}`;
                const existingPay = payMap.get(key);

                const eligible = x.count >= 10;

                // règle: 1000 à partir de 10, +500 par tranche de 5 au-delà
                let bonusAmount = 0;
                if (eligible) {
                    const extraSets = Math.floor((x.count - 10) / 5);
                    bonusAmount = 1000 + extraSets * 500;
                }

                // statut: si payment existe => son statut, sinon pending si eligible, sinon null
                const payment_status = existingPay?.payment_status || (eligible ? 'pending' : null);

                return {
                    ...x,
                    prof,
                    user,
                    eligible,
                    bonusAmount,
                    payment: existingPay || null,
                    payment_status
                };
                });

                window.__referrersComputed = computed;

                // 7) Stats cards
                const totalReferrals = (referrals || []).length;
                const totalBonusVotes = (referrals || []).reduce((s, r) => s + (r.bonus_votes_granted || 0), 0);
                const totalPaid = (payments || []).filter(p => p.payment_status === 'paid').reduce((s, p) => s + (p.bonus_amount || 0), 0);
                const totalPending = computed.filter(x => x.eligible && x.payment_status === 'pending').reduce((s, x) => s + (x.bonusAmount || 0), 0);

                document.getElementById('referralStats').innerHTML = `
                <div class="stat-card">
                    <div class="icon green"><i class="fas fa-user-friends"></i></div>
                    <div class="info"><h4>${totalReferrals}</h4><p>Parrainages Total</p></div>
                </div>
                <div class="stat-card">
                    <div class="icon gold"><i class="fas fa-vote-yea"></i></div>
                    <div class="info"><h4>${totalBonusVotes}</h4><p>Votes Bonus (parrain)</p></div>
                </div>
                <div class="stat-card">
                    <div class="icon blue"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="info"><h4>${totalPaid.toLocaleString()} F</h4><p>Primes Payées</p></div>
                </div>
                <div class="stat-card">
                    <div class="icon red"><i class="fas fa-clock"></i></div>
                    <div class="info"><h4>${totalPending.toLocaleString()} F</h4><p>Primes en Attente</p></div>
                </div>
                `;

                // 8) Afficher onglet éligibles par défaut
                renderReferrersTabs('allReferrers');

            } catch (error) {
                console.error('Referrals error:', error);
                showToast('Erreur de chargement des parrainages', 'error');
            }

            hideLoading();
            }
        
        async function renderEligibleReferrers(payments) {
            const container = document.getElementById('referralsContent');
            
            // Get eligible (pending payment)
            const eligiblePayments = payments.filter(p => p.payment_status === 'pending');
            
            if (eligiblePayments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-friends"></i>
                        <h4>Aucun parrain éligible au paiement</h4>
                        <p>Les parrains avec 10+ filleuls apparaîtront ici</p>
                    </div>
                `;
                return;
            }
            
            // Load user info for each payment
            for (let payment of eligiblePayments) {
                if (payment.referrer?.user_id) {
                    const { data: user } = await supabaseClient
                        .from('users')
                        .select('full_name, photo_url, whatsapp_number, mobile_money_number, mobile_money_type')
                        .eq('id', payment.referrer.user_id)
                        .single();
                    payment.user = user;
                }
            }
            
            container.innerHTML = eligiblePayments.map(payment => `
                <div class="referral-payment-card">
                    <div class="referral-user-info">
                        <img src="${payment.user?.photo_url || 'https://via.placeholder.com/50?text=U'}" alt="">
                        <div class="details">
                            <h5>${payment.user?.full_name || 'Utilisateur'}</h5>
                            <p>${payment.games?.title || 'Jeu'}</p>
                        </div>
                    </div>
                    
                    <div class="referral-stats">
                        <div class="referral-stat">
                            <span class="value">${payment.referral_count}</span>
                            <span class="label">Filleuls</span>
                        </div>
                        <div class="referral-stat">
                            <span class="value" style="color: var(--accent);">${payment.bonus_amount?.toLocaleString()} F</span>
                            <span class="label">Prime</span>
                        </div>
                    </div>
                    
                    <div class="referral-actions">
                        <span class="badge badge-warning">
                            <i class="fas fa-clock"></i> En attente
                        </span>
                        <button class="btn btn-success btn-sm" onclick="markAsPaid('${payment.id}')">
                            <i class="fas fa-check"></i> Marquer payé
                        </button>
                        ${payment.user?.whatsapp_number ? `
                            <a href="https://wa.me/${payment.user.whatsapp_number.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(`Bonjour ${payment.user.full_name} ! Votre prime de parrainage de ${payment.bonus_amount} FCFA pour "${payment.games?.title}" a été envoyée sur votre compte ${payment.user.mobile_money_type} (${payment.user.mobile_money_number}). Merci pour votre participation !`)}" 
                               target="_blank" class="btn btn-primary btn-sm">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        async function markAsPaid(paymentId) {
            if (!confirm('Confirmer que le paiement a été effectué ?')) return;
            
            showLoading('Mise à jour...');
            
            try {
                await supabaseClient
                    .from('referral_payments')
                    .update({ 
                        payment_status: 'paid',
                        paid_at: new Date().toISOString()
                    })
                    .eq('id', paymentId);
                
                await logAdminActivity('pay_referral', `Prime de parrainage payée`);
                
                showToast('Paiement marqué comme effectué !', 'success');
                await loadReferrals();
                
            } catch (error) {
                console.error('Payment error:', error);
                showToast('Erreur lors de la mise à jour', 'error');
            }
            
            hideLoading();
        }
        
        async function calculateReferralPayments(gameId) {
            try {
                // Get all referrers for this game
                const { data: referrals } = await supabaseClient
                    .from('referrals')
                    .select('referrer_id')
                    .eq('game_id', gameId);
                
                // Group by referrer
                const referrerCounts = {};
                referrals?.forEach(r => {
                    referrerCounts[r.referrer_id] = (referrerCounts[r.referrer_id] || 0) + 1;
                });
                
                // Calculate bonuses for eligible referrers (10+ referrals)
                for (let [referrerId, count] of Object.entries(referrerCounts)) {
                    if (count >= 10) {
                        // Base bonus for 10 + extra for each 5 above 10
                        const extraSets = Math.floor((count - 10) / 5);
                        const bonusAmount = 1000 + (extraSets * 500);
                        
                        // Check if payment already exists
                        const { data: existing } = await supabaseClient
                            .from('referral_payments')
                            .select('id')
                            .eq('referrer_id', referrerId)
                            .eq('game_id', gameId)
                            .single();
                        
                        if (!existing) {
                            await supabaseClient
                                .from('referral_payments')
                                .insert([{
                                    referrer_id: referrerId,
                                    game_id: gameId,
                                    referral_count: count,
                                    bonus_amount: bonusAmount,
                                    payment_status: 'pending'
                                }]);
                        }
                    }
                }
            } catch (error) {
                console.error('Calculate referral payments error:', error);
            }
        }
        
        // ============================================
        // FINANCES
        // ============================================
        async function loadFinances() {
            showLoading('Chargement des finances...');
            
            try {
                // Get all games with financial data
                const { data: games } = await supabaseClient
                    .from('games')
                    .select('*')
                    .in('status', ['active', 'ended', 'archived'])
                    .order('created_at', { ascending: false });
                
                let totalRegistrationRevenue = 0;
                let totalVoteRevenue = 0;
                let totalReferralPaid = 0;
                
                const gameFinancials = [];
                
                for (let game of (games || [])) {
                    // Count approved candidates
                    const { count: candidatesCount } = await supabaseClient
                        .from('game_entries')
                        .select('*', { count: 'exact', head: true })
                        .eq('game_id', game.id)
                        .eq('status', 'approved');
                    
                    const registrationRevenue = (candidatesCount || 0) * (game.registration_fee || 0);
                    
                    // Get paid votes revenue
                    const { data: paidVotes } = await supabaseClient
                        .from('votes')
                        .select('amount_paid')
                        .eq('game_id', game.id)
                        .eq('vote_type', 'paid');
                    
                    const voteRevenue = paidVotes?.reduce((sum, v) => sum + (v.amount_paid || 0), 0) || 0;
                    
                    // Get referral payments
                    const { data: refPayments } = await supabaseClient
                        .from('referral_payments')
                        .select('bonus_amount')
                        .eq('game_id', game.id)
                        .eq('payment_status', 'paid');
                    
                    const referralPaid = refPayments?.reduce((sum, p) => sum + (p.bonus_amount || 0), 0) || 0;
                    
                    const netProfit = registrationRevenue + voteRevenue - referralPaid;
                    
                    gameFinancials.push({
                        game,
                        candidatesCount: candidatesCount || 0,
                        registrationRevenue,
                        voteRevenue,
                        totalRevenue: registrationRevenue + voteRevenue,
                        referralPaid,
                        netProfit
                    });
                    
                    totalRegistrationRevenue += registrationRevenue;
                    totalVoteRevenue += voteRevenue;
                    totalReferralPaid += referralPaid;
                }
                
                const totalRevenue = totalRegistrationRevenue + totalVoteRevenue;
                const netProfit = totalRevenue - totalReferralPaid;
                
                // Display cards
                document.getElementById('financialCards').innerHTML = `
                    <div class="financial-card">
                        <div class="amount">${totalRegistrationRevenue.toLocaleString()} F</div>
                        <div class="label">Revenus Inscriptions</div>
                    </div>
                    <div class="financial-card">
                        <div class="amount">${totalVoteRevenue.toLocaleString()} F</div>
                        <div class="label">Revenus Votes</div>
                    </div>
                    <div class="financial-card">
                        <div class="amount">${totalRevenue.toLocaleString()} F</div>
                        <div class="label">Total Revenus</div>
                    </div>
                    <div class="financial-card expense">
                        <div class="amount">${totalReferralPaid.toLocaleString()} F</div>
                        <div class="label">Primes Parrainage</div>
                    </div>
                    <div class="financial-card profit">
                        <div class="amount">${netProfit.toLocaleString()} F</div>
                        <div class="label">Bénéfice Net</div>
                    </div>
                `;
                
                // Display table
                document.getElementById('financesByGameBody').innerHTML = gameFinancials.map(gf => `
                    <tr>
                        <td>
                            <strong>${gf.game.title}</strong>
                            <br><small style="color: var(--gray);">${formatDate(gf.game.start_time)}</small>
                        </td>
                        <td>${gf.registrationRevenue.toLocaleString()} F <small>(${gf.candidatesCount} × ${gf.game.registration_fee}F)</small></td>
                        <td>${gf.voteRevenue.toLocaleString()} F</td>
                        <td><strong>${gf.totalRevenue.toLocaleString()} F</strong></td>
                        <td style="color: var(--danger);">-${gf.referralPaid.toLocaleString()} F</td>
                        <td style="color: ${gf.netProfit >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 700;">
                            ${gf.netProfit.toLocaleString()} F
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="6" style="text-align: center; color: var(--gray);">Aucune donnée</td></tr>';
                
                // Load chart
                await loadFinancialChart();
                
            } catch (error) {
                console.error('Finances error:', error);
                showToast('Erreur de chargement des finances', 'error');
            }
            
            hideLoading();
        }
        
        async function loadFinancialChart() {
  const ctx = document.getElementById('financialChart');
  if (!ctx) return;

  const periodRaw = document.getElementById('financePeriodFilter')?.value || '30';
  const period = periodRaw === 'all' ? 'all' : parseInt(periodRaw, 10);

  // Début période
  const start = new Date();
  start.setHours(0,0,0,0);
  if (period === 'all') {
    start.setFullYear(start.getFullYear() - 5); // 5 ans
  } else {
    start.setDate(start.getDate() - (period - 1));
  }

  // 1) Votes payants sur la période
  const { data: paidVotes, error: pvErr } = await supabaseClient
    .from('votes')
    .select('voted_at, amount_paid')
    .eq('vote_type', 'paid')
    .gte('voted_at', start.toISOString());

  if (pvErr) {
    console.error(pvErr);
    showToast("Erreur chargement votes payants", "error");
    return;
  }

  // 2) Inscriptions approuvées sur la période (on prend registration_fee du jeu)
  const { data: approvedEntries, error: aeErr } = await supabaseClient
    .from('game_entries')
    .select('approved_at, status, games:game_id(registration_fee)')
    .eq('status', 'approved')
    .gte('approved_at', start.toISOString());

  if (aeErr) {
    console.error(aeErr);
    showToast("Erreur chargement inscriptions", "error");
    return;
  }

  // 3) Construire buckets par jour
  const buckets = new Map();
  const labels = [];

  // helper: YYYY-MM-DD
  const keyOf = (d) => {
    const dt = new Date(d);
    dt.setHours(0,0,0,0);
    return dt.toISOString().slice(0,10);
  };

  const daysCount = period === 'all' ? 365 : period; // affichage max 365 points pour lisibilité
  const start2 = new Date(start);
  if (period === 'all') {
    // pour "all", on affiche 12 mois plutôt (sinon trop)
    // => on fait regroupement mensuel
    return await loadFinancialChartMonthly(ctx, start);
  } else {
    for (let i = 0; i < daysCount; i++) {
      const d = new Date(start2);
      d.setDate(start2.getDate() + i);
      const k = keyOf(d);
      buckets.set(k, { reg: 0, votes: 0, total: 0 });
      labels.push(d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }));
    }

    // votes payants
    (paidVotes || []).forEach(v => {
      const k = keyOf(v.voted_at);
      if (buckets.has(k)) buckets.get(k).votes += Number(v.amount_paid || 0);
    });

    // inscriptions
    (approvedEntries || []).forEach(e => {
      const k = keyOf(e.approved_at);
      if (buckets.has(k)) buckets.get(k).reg += Number(e.games?.registration_fee || 0);
    });

    // totals
    const totals = [];
    const regSeries = [];
    const voteSeries = [];
    Array.from(buckets.values()).forEach(b => {
      b.total = b.reg + b.votes;
      regSeries.push(b.reg);
      voteSeries.push(b.votes);
      totals.push(b.total);
    });

    if (financialChart) financialChart.destroy();

    financialChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Total',
            data: totals,
            borderColor: 'rgba(212, 175, 55, 1)',
            backgroundColor: 'rgba(212, 175, 55, 0.12)',
            tension: 0.35,
            fill: true,
            pointRadius: 2
          },
          {
            label: 'Inscriptions',
            data: regSeries,
            borderColor: 'rgba(23, 162, 184, 1)',
            backgroundColor: 'rgba(23, 162, 184, 0.05)',
            tension: 0.35,
            fill: false,
            pointRadius: 2
          },
          {
            label: 'Votes payants',
            data: voteSeries,
            borderColor: 'rgba(40, 167, 69, 1)',
            backgroundColor: 'rgba(40, 167, 69, 0.05)',
            tension: 0.35,
            fill: false,
            pointRadius: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${Number(ctx.parsed.y || 0).toLocaleString()} FCFA`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: (v) => `${Number(v).toLocaleString()} F`
            }
          }
        }
      }
    });
  }
}

// Regroupement mensuel pour "all"
async function loadFinancialChartMonthly(ctx, startDate) {
  const start = new Date(startDate);

  const { data: paidVotes } = await supabaseClient
    .from('votes')
    .select('voted_at, amount_paid')
    .eq('vote_type', 'paid')
    .gte('voted_at', start.toISOString());

  const { data: approvedEntries } = await supabaseClient
    .from('game_entries')
    .select('approved_at, games:game_id(registration_fee)')
    .eq('status', 'approved')
    .gte('approved_at', start.toISOString());

  const buckets = new Map(); // YYYY-MM => {reg, votes}
  const keyMonth = (d) => {
    const dt = new Date(d);
    return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
  };

  // 12 derniers mois
  const labels = [];
  const now = new Date();
  for (let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const k = keyMonth(d);
    buckets.set(k, { reg: 0, votes: 0, total: 0 });
    labels.push(d.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' }));
  }

  (paidVotes || []).forEach(v => {
    const k = keyMonth(v.voted_at);
    if (buckets.has(k)) buckets.get(k).votes += Number(v.amount_paid || 0);
  });

  (approvedEntries || []).forEach(e => {
    const k = keyMonth(e.approved_at);
    if (buckets.has(k)) buckets.get(k).reg += Number(e.games?.registration_fee || 0);
  });

  const totals = [], regSeries = [], voteSeries = [];
  Array.from(buckets.values()).forEach(b => {
    b.total = b.reg + b.votes;
    regSeries.push(b.reg);
    voteSeries.push(b.votes);
    totals.push(b.total);
  });

  if (financialChart) financialChart.destroy();

  financialChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Total', data: totals, borderColor: 'rgba(212,175,55,1)', backgroundColor: 'rgba(212,175,55,0.12)', tension: .35, fill: true, pointRadius: 2 },
        { label: 'Inscriptions', data: regSeries, borderColor: 'rgba(23,162,184,1)', tension: .35, fill: false, pointRadius: 2 },
        { label: 'Votes payants', data: voteSeries, borderColor: 'rgba(40,167,69,1)', tension: .35, fill: false, pointRadius: 2 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } },
      scales: { y: { beginAtZero: true, ticks: { callback: v => `${Number(v).toLocaleString()} F` } } }
    }
  });
}
        
        // ============================================
        // VOTES MANAGEMENT
        // ============================================
        async function loadVotes() {
            showLoading('Chargement des votes...');
            
            try {
                // Stats
                const { data: allVotesData } = await supabaseClient
                    .from('votes')
                    .select('vote_type, vote_count, amount_paid');
                
                const totalVotes = allVotesData?.reduce((sum, v) => sum + (v.vote_count || 1), 0) || 0;
                const freeVotes = allVotesData?.filter(v => v.vote_type === 'free').reduce((sum, v) => sum + (v.vote_count || 1), 0) || 0;
                const paidVotes = allVotesData?.filter(v => v.vote_type === 'paid').reduce((sum, v) => sum + (v.vote_count || 1), 0) || 0;
                // bonus = somme referral_bonus_votes depuis game_entries
                const { data: bonusEntries } = await supabaseClient
                .from('game_entries')
                .select('referral_bonus_votes');

                const bonusVotes = allVotesData
                    ?.filter(v => v.vote_type === 'bonus')
                    .reduce((sum, v) => sum + (v.vote_count || 1), 0) || 0;
                const totalRevenue = allVotesData?.reduce((sum, v) => sum + (v.amount_paid || 0), 0) || 0;
                
                document.getElementById('votesStats').innerHTML = `
                    <div class="stat-card">
                        <div class="icon gold"><i class="fas fa-vote-yea"></i></div>
                        <div class="info">
                            <h4>${totalVotes.toLocaleString()}</h4>
                            <p>Total Votes</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon green"><i class="fas fa-gift"></i></div>
                        <div class="info">
                            <h4>${freeVotes.toLocaleString()}</h4>
                            <p>Votes Gratuits</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon blue"><i class="fas fa-coins"></i></div>
                        <div class="info">
                            <h4>${paidVotes.toLocaleString()}</h4>
                            <p>Votes Payants</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon purple"><i class="fas fa-star"></i></div>
                        <div class="info">
                            <h4>${bonusVotes.toLocaleString()}</h4>
                            <p>Votes Bonus</p>
                        </div>
                    </div>
                `;
                
                // Load votes list
                const { data: votes, error } = await supabaseClient
                    .from('votes')
                    .select(`
                        *,
                        voter:voter_id (full_name, photo_url),
                        game_entries:candidate_entry_id (
                            candidate_number,
                            users:user_id (full_name)
                        ),
                        games:game_id (title)
                    `)
                    .order('voted_at', { ascending: false })
                    .limit(100);
                
                if (error) throw error;
                
                allVotes = votes || [];
                
                // Populate game filter
                const { data: games } = await supabaseClient
                    .from('games')
                    .select('id, title, status, start_time')
                    .order('created_at', { ascending: false });
                document.getElementById('voteGameFilter').innerHTML = `
                    <option value="">Tous les jeux</option>
                    ${(games || []).map(g => `<option value="${g.id}">${g.title}</option>`).join('')}
                `;
                
                document.getElementById('voteGameSelect').innerHTML = `
                    <option value="">Sélectionnez un jeu</option>
                    ${(games || [])
                        .filter(g => ['active','pending','ended'].includes(g.status))
                        .map(g => `<option value="${g.id}">${g.title} (${g.status})</option>`)
                        .join('')}
                    `;
                
                renderVotes(allVotes);
                
            } catch (error) {
                console.error('Votes error:', error);
                showToast('Erreur de chargement des votes', 'error');
            }
            
            hideLoading();
        }
        
        function renderVotes(votes) {
            document.getElementById('votesTableBody').innerHTML = votes.map(vote => `
                <tr>
                    <td>
                        <div class="table-user">
                            <img src="${vote.voter?.photo_url || 'https://via.placeholder.com/40?text=?'}" alt="">
                            <div>
                                <span class="name">${vote.voter?.full_name || 'Anonyme'}</span>
                                <span class="email">${vote.voter_ip || ''}</span>
                            </div>
                        </div>
                    </td>
                    <td>${vote.game_entries?.users?.full_name || 'N/A'}</td>
                    <td>${vote.games?.title || 'N/A'}</td>
                    <td>
                        <span class="badge badge-${vote.vote_type === 'free' ? 'success' : vote.vote_type === 'paid' ? 'info' : 'gold'}">
                            ${vote.vote_type === 'free' ? 'Gratuit' : vote.vote_type === 'paid' ? 'Payant' : 'Bonus'}
                        </span>
                    </td>
                    <td><strong>${vote.vote_count || 1}</strong></td>
                    <td>${vote.amount_paid ? vote.amount_paid.toLocaleString() + ' F' : '-'}</td>
                    <td>${formatDateTime(vote.voted_at)}</td>
                </tr>
            `).join('') || '<tr><td colspan="7" style="text-align: center; color: var(--gray);">Aucun vote</td></tr>';
        }
        
        function filterVotes() {
            const gameId = document.getElementById('voteGameFilter').value;
            const type = document.getElementById('voteTypeFilter').value;
            
            let filtered = [...allVotes];
            
            if (gameId) {
                filtered = filtered.filter(v => v.game_id === gameId);
            }
            
            if (type) {
                filtered = filtered.filter(v => v.vote_type === type);
            }
            
            renderVotes(filtered);
        }
        
        function openAddVotesModal() {
            document.getElementById('addVotesForm').reset();
            document.getElementById('voteCandidateSelect').innerHTML = '<option value="">Sélectionnez d\'abord un jeu</option>';
            openModal('addVotesModal');
        }
        
        async function loadGameCandidates() {
            const gameId = document.getElementById('voteGameSelect').value;
            const select = document.getElementById('voteCandidateSelect');
            
            if (!gameId) {
                select.innerHTML = '<option value="">Sélectionnez d\'abord un jeu</option>';
                return;
            }
            
            const { data: candidates, error } = await supabaseClient
                .from('game_entries')
                .select(`id, candidate_number, status, users:user_id(full_name)`)
                .eq('game_id', gameId)
                .in('status', ['approved','pending'])
                .order('created_at', { ascending: false });

                if (error) throw error;
                select.innerHTML = `
                    <option value="">Sélectionnez un candidat</option>
                    ${(candidates || []).map(c => `
                        <option value="${c.id}">
                        ${c.users?.full_name || 'N/A'} (${c.candidate_number}) - ${c.status}
                        </option>
                    `).join('')}
                    `;
        }
        
        async function addVotes() {
            const gameId = document.getElementById('voteGameSelect').value;
            const candidateEntryId = document.getElementById('voteCandidateSelect').value;
            const voteType = document.getElementById('voteTypeSelect').value;
            const voteCount = parseInt(document.getElementById('voteCountInput').value);
            const amountPaid = parseFloat(document.getElementById('voteAmountInput').value) || 0;
            
            if (!gameId || !candidateEntryId || !voteCount) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            showLoading('Ajout des votes...');
            
            try {
                // Create vote record
                // 1) Insérer le vote (source de vérité)
                const { error: rpcErr } = await supabaseClient.rpc('admin_add_votes', {
                    p_admin_id: adminUser.id,
                    p_game_id: gameId,
                    p_candidate_entry_id: candidateEntryId,
                    p_vote_type: voteType,
                    p_vote_count: voteCount,
                    p_amount_paid: amountPaid
                    });
                    if (rpcErr) throw rpcErr;
                // 2) NE PAS toucher game_entries.*_votes ici
                // Les triggers SQL recalc_entry_votes() vont recalculer automatiquement
                
                await logAdminActivity('add_votes', `${voteCount} votes ajoutés manuellement`);
                
                closeModal('addVotesModal');
                showToast('Votes ajoutés avec succès !', 'success');
                await loadVotes();
                
            } catch (error) {
                console.error('Add votes error:', error);
                showToast('Erreur lors de l\'ajout des votes', 'error');
            }
            
            hideLoading();
        }
        
        // ============================================
        // USERS MANAGEMENT
        // ============================================
        async function loadUsers() {
            showLoading('Chargement des utilisateurs...');
            
            try {
                const { data: users, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allUsers = users || [];
                renderUsers(allUsers);
                
            } catch (error) {
                console.error('Users error:', error);
                showToast('Erreur de chargement des utilisateurs', 'error');
            }
            
            hideLoading();
        }
        
        function renderUsers(users) {
            document.getElementById('usersTableBody').innerHTML = users.map(user => `
                <tr>
                    <td>
                        <div class="table-user">
                            <img src="${user.photo_url || 'https://via.placeholder.com/40?text=U'}" alt="">
                            <div>
                                <span class="name">${user.full_name}</span>
                                <span class="email">${user.email}</span>
                            </div>
                        </div>
                    </td>
                    <td>${user.phone || '-'}</td>
                    <td>
                        <span class="badge badge-${user.role === 'admin' ? 'danger' : user.role === 'candidate' ? 'success' : 'primary'}">
                            ${user.role === 'admin' ? 'Admin' : user.role === 'candidate' ? 'Candidat' : 'Utilisateur'}
                        </span>
                    </td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>
                        <span class="badge badge-${user.is_banned ? 'danger' : 'success'}">
                            ${user.is_banned ? 'Banni' : 'Actif'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group">
                            ${user.role !== 'admin' ? `
                                <button class="btn btn-outline btn-sm" onclick="viewUserDetails('${user.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-${user.is_banned ? 'success' : 'warning'} btn-sm" 
                                        onclick="${user.is_banned ? 'unban' : 'ban'}User('${user.id}')">
                                    <i class="fas fa-${user.is_banned ? 'unlock' : 'ban'}"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : '<span class="badge badge-gold">Protégé</span>'}
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function filterUsers() {
            const role = document.getElementById('userRoleFilter').value;
            const search = document.getElementById('userSearchInput').value.toLowerCase();
            
            let filtered = [...allUsers];
            
            if (role) {
                filtered = filtered.filter(u => u.role === role);
            }
            
            if (search) {
                filtered = filtered.filter(u => 
                    u.full_name.toLowerCase().includes(search) ||
                    u.email.toLowerCase().includes(search) ||
                    (u.phone && u.phone.includes(search))
                );
            }
            
            renderUsers(filtered);
        }
        
        async function banUser(userId) {
            if (!confirm('Bannir cet utilisateur ?')) return;
            
            try {
                await supabaseClient
                    .from('users')
                    .update({ is_banned: true })
                    .eq('id', userId);
                
                await logAdminActivity('ban_user', `Utilisateur banni`);
                
                showToast('Utilisateur banni', 'success');
                await loadUsers();
            } catch (error) {
                showToast('Erreur', 'error');
            }
        }
        
        async function unbanUser(userId) {
            try {
                await supabaseClient
                    .from('users')
                    .update({ is_banned: false })
                    .eq('id', userId);
                
                await logAdminActivity('unban_user', `Utilisateur débanni`);
                
                showToast('Utilisateur débanni', 'success');
                await loadUsers();
            } catch (error) {
                showToast('Erreur', 'error');
            }
        }
        
        async function deleteUser(userId) {
            if (!confirm('Supprimer définitivement cet utilisateur ?')) return;
            
            try {
                await supabaseClient.from('users').delete().eq('id', userId);
                
                await logAdminActivity('delete_user', `Utilisateur supprimé`);
                
                showToast('Utilisateur supprimé', 'success');
                await loadUsers();
            } catch (error) {
                showToast('Erreur lors de la suppression', 'error');
            }
        }
        
        async function exportUsers() {
            const csv = ['Nom,Email,Téléphone,Rôle,Date inscription'];
            allUsers.forEach(u => {
                csv.push(`"${u.full_name}","${u.email}","${u.phone || ''}","${u.role}","${u.created_at}"`);
            });
            
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `users_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showToast('Export téléchargé', 'success');
        }
        
        // ============================================
        // ADVERTISEMENTS
        // ============================================
        async function loadAds() {
            showLoading('Chargement des publicités...');
            
            try {
                const { data: ads, error } = await supabaseClient
                    .from('advertisements')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allAds = ads || [];
                renderAds(allAds);
                
            } catch (error) {
                console.error('Ads error:', error);
                showToast('Erreur de chargement des publicités', 'error');
            }
            
            hideLoading();
        }
        
        function renderAds(ads) {
    const container = document.getElementById('adsContent');
    const statsCache = window.adStatsCache || {}; // Utilise le cache calculé plus haut

    if (!ads.length) { container.innerHTML = '... vide ...'; return; }

    container.innerHTML = `<div style="display: grid; gap: 20px;">
        ${ads.map(ad => {
            const s = statsCache[ad.id] || { views: 0, clicks: 0, time: 0 };
            const ctr = s.views > 0 ? ((s.clicks / s.views) * 100).toFixed(1) : 0;
            const avgTime = s.views > 0 ? (s.time / s.views).toFixed(1) : 0;

            return `
            <div style="background:var(--light-bg); border-radius:15px; padding:20px; display:flex; gap:20px; align-items:center;">
                <!-- Image ... -->
                <div style="width:120px;">
                   ${ad.media_type==='video' ? 'VIDEO' : `<img src="${ad.media_url}" style="width:100%;border-radius:10px;">`}
                </div>
                
                <!-- Infos ... -->
                <div style="flex:1;">
                    <h4>${ad.title}</h4>
                    
                    <!-- BARRE DE STATS -->
                    <div style="display:flex; gap:15px; margin-top:10px; font-size:0.9rem; color:var(--gray);">
                        <span title="Vues"><i class="fas fa-eye"></i> <strong>${s.views}</strong></span>
                        <span title="Clics"><i class="fas fa-mouse-pointer"></i> <strong>${s.clicks}</strong></span>
                        <span title="Taux de clic"><i class="fas fa-percentage"></i> <strong>${ctr}%</strong></span>
                        <span title="Temps moyen"><i class="fas fa-stopwatch"></i> <strong>${avgTime}s</strong></span>
                    </div>
                </div>

                <!-- Actions ... -->
                <div class="btn-group">...</div>
            </div>
            `;
        }).join('')}
    </div>`;
}
        
        function openCreateAdModal() {
            document.getElementById('createAdForm').reset();
            document.getElementById('adMediaPreview').style.display = 'none';
            document.getElementById('adMediaUpload').classList.remove('has-file');
            adMediaFile = null;
            openModal('createAdModal');
        }
        
        function previewAdMedia(input) {
            const file = input.files[0];
            if (!file) return;
            
            adMediaFile = file;
            
            const upload = document.getElementById('adMediaUpload');
            const preview = document.getElementById('adMediaPreview');
            
            upload.classList.add('has-file');
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        }
        
        async function createAd() {
            const position = document.getElementById('adPosition').value;
            const title = document.getElementById('adTitle').value.trim();
            const description = document.getElementById('adDescription').value.trim();
            const buttonText = document.getElementById('adButtonText').value.trim();
            const buttonLink = document.getElementById('adButtonLink').value.trim();
            const isActive = document.getElementById('adIsActive').checked;
            
            if (!title || !adMediaFile) {
                showToast('Titre et média requis', 'error');
                return;
            }
            
            showLoading('Création de la publicité...');
            
            try {
                // Upload media
                const mediaUrl = await uploadToCloudinary(adMediaFile, 'ads');
                const mediaType = adMediaFile.type.startsWith('video/') ? 'video' : 'image';
                
                // Create ad
                await supabaseClient
                    .from('advertisements')
                    .insert([{
                        position,
                        title,
                        description,
                        media_url: mediaUrl,
                        media_type: mediaType,
                        button_text: buttonText,
                        button_link: buttonLink,
                        is_active: isActive
                    }]);
                
                await logAdminActivity('create_ad', `Publicité créée: ${title}`);
                
                closeModal('createAdModal');
                showToast('Publicité créée !', 'success');
                await loadAds();
                
            } catch (error) {
                console.error('Create ad error:', error);
                showToast('Erreur lors de la création', 'error');
            }
            
            hideLoading();
        }
        
        async function toggleAdStatus(adId, isActive) {
            try {
                await supabaseClient
                    .from('advertisements')
                    .update({ is_active: isActive })
                    .eq('id', adId);
                
                showToast(`Publicité ${isActive ? 'activée' : 'désactivée'}`, 'success');
                await loadAds();
            } catch (error) {
                showToast('Erreur', 'error');
            }
        }
        
        async function deleteAd(adId) {
            if (!confirm('Supprimer cette publicité ?')) return;
            
            try {
                await supabaseClient.from('advertisements').delete().eq('id', adId);
                
                await logAdminActivity('delete_ad', `Publicité supprimée`);
                
                showToast('Publicité supprimée', 'success');
                await loadAds();
            } catch (error) {
                showToast('Erreur', 'error');
            }
        }
        
        // ============================================
        // SPONSORS
        // ============================================
        async function loadSponsors() {
            showLoading('Chargement des sponsors...');
            
            try {
                const { data: sponsors, error } = await supabaseClient
                    .from('sponsors')
                    .select('*')
                    .order('display_order', { ascending: true });
                
                if (error) throw error;
                
                allSponsors = sponsors || [];
                renderSponsors(allSponsors);
                
            } catch (error) {
                console.error('Sponsors error:', error);
            }
            
            hideLoading();
        }
        
        function renderSponsors(sponsors) {
            const container = document.getElementById('sponsorsContent');
            
            if (sponsors.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-handshake"></i>
                        <h4>Aucun sponsor</h4>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                    ${sponsors.map(s => `
                        <div style="background: var(--light-bg); border-radius: 15px; padding: 20px; text-align: center;">
                            <img src="${s.logo_url || 'https://via.placeholder.com/150x80?text=Logo'}" 
                                 alt="${s.name}" style="max-width: 150px; max-height: 80px; margin-bottom: 15px;">
                            <h4 style="color: var(--primary);">${s.name}</h4>
                            <p style="color: var(--gray); font-size: 0.85rem;">${s.description || ''}</p>
                            <div class="btn-group" style="margin-top: 15px; justify-content: center;">
                                <span class="badge badge-${s.is_active ? 'success' : 'danger'}">
                                    ${s.is_active ? 'Actif' : 'Inactif'}
                                </span>
                                <button class="btn btn-danger btn-sm" onclick="deleteSponsor('${s.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        async function deleteSponsor(sponsorId) {
            if (!confirm('Supprimer ce sponsor ?')) return;
            
            try {
                await supabaseClient.from('sponsors').delete().eq('id', sponsorId);
                showToast('Sponsor supprimé', 'success');
                await loadSponsors();
            } catch (error) {
                showToast('Erreur', 'error');
            }
        }
        
        // ============================================
        // TESTIMONIALS
        // ============================================
        async function loadTestimonials() {
            showLoading('Chargement des témoignages...');
            
            try {
                const { data: testimonials, error } = await supabaseClient
                    .from('testimonials')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                renderTestimonials(testimonials || []);
                
            } catch (error) {
                console.error('Testimonials error:', error);
            }
            
            hideLoading();
        }
        
        function renderTestimonials(testimonials) {
            const container = document.getElementById('testimonialsContent');
            
            if (testimonials.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-quote-left"></i>
                        <h4>Aucun témoignage</h4>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="display: grid; gap: 20px;">
                    ${testimonials.map(t => `
                        <div style="background: var(--light-bg); border-radius: 15px; padding: 25px; display: flex; gap: 20px; align-items: flex-start;">
                            <img src="${t.photo_url || 'https://via.placeholder.com/60?text=Photo'}" 
                                 style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
                            <div style="flex: 1;">
                                <p style="color: var(--gray); font-style: italic; margin-bottom: 15px;">"${t.quote}"</p>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="color: var(--primary);">${t.name}</strong>
                                        ${t.game_title ? `<br><small style="color: var(--gray);">${t.game_title} - ${t.rank_achieved}ème</small>` : ''}
                                    </div>
                                    <div class="btn-group">
                                        <span class="badge badge-${t.is_active ? 'success' : 'danger'}">
                                            ${t.is_active ? 'Actif' : 'Inactif'}
                                        </span>
                                        <button class="btn btn-danger btn-sm" onclick="deleteTestimonial('${t.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        async function deleteTestimonial(testimonialId) {
            if (!confirm('Supprimer ce témoignage ?')) return;
            
            try {
                await supabaseClient.from('testimonials').delete().eq('id', testimonialId);
                showToast('Témoignage supprimé', 'success');
                await loadTestimonials();
            } catch (error) {
                showToast('Erreur', 'error');
            }
        }
        
        // ============================================
        // LOGS
        // ============================================
        async function loadLogs() {
            showLoading('Chargement des logs...');
            
            try {
                const { data: logs, error } = await supabaseClient
                    .from('activity_logs')
                    .select('*, users(full_name)')
                    .order('created_at', { ascending: false })
                    .limit(200);
                
                if (error) throw error;
                
                allLogs = logs || [];
                renderLogs(allLogs);
                
            } catch (error) {
                console.error('Logs error:', error);
            }
            
            hideLoading();
        }
        
        function renderLogs(logs) {
            document.getElementById('logsTableBody').innerHTML = logs.map(log => `
                <tr>
                    <td>${formatDateTime(log.created_at)}</td>
                    <td>${log.users?.full_name || 'Système'}</td>
                    <td><span class="badge badge-primary">${log.action_type}</span></td>
                    <td>${log.description || '-'}</td>
                    <td><code>${log.ip_address || '-'}</code></td>
                </tr>
            `).join('') || '<tr><td colspan="5" style="text-align: center;">Aucun log</td></tr>';
        }
        
        function filterLogs() {
            const type = document.getElementById('logTypeFilter').value;
            const date = document.getElementById('logDateFilter').value;
            
            let filtered = [...allLogs];
            
            if (type) {
                filtered = filtered.filter(l => l.action_type === type);
            }
            
            if (date) {
                filtered = filtered.filter(l => l.created_at.startsWith(date));
            }
            
            renderLogs(filtered);
        }
        
        async function exportLogs() {
            const csv = ['Date,Utilisateur,Action,Description,IP'];
            allLogs.forEach(l => {
                csv.push(`"${l.created_at}","${l.users?.full_name || 'Système'}","${l.action_type}","${l.description || ''}","${l.ip_address || ''}"`);
            });
            
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `logs_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showToast('Logs exportés', 'success');
        }
        
        // ============================================
        // SETTINGS
        // ============================================
        async function saveSettings(e) {
            e.preventDefault();
            
            showLoading('Enregistrement...');
            
            try {
                const settings = {
                    site_info: {
                        name: document.getElementById('settingSiteName').value,
                        tagline: document.getElementById('settingTagline').value
                    },
                    payment_info: {
                        mtn_number: document.getElementById('settingMTN').value,
                        moov_number: document.getElementById('settingMoov').value,
                        celtiis_number: document.getElementById('settingCeltiis').value,
                        recipient_name: document.getElementById('settingRecipient').value,
                        whatsapp: document.getElementById('settingWhatsapp').value
                    },
                    referral_settings: {
                        bonus_votes_referrer: parseInt(document.getElementById('settingReferrerBonus').value),
                        bonus_votes_referee: parseInt(document.getElementById('settingRefereeBonus').value),
                        bonus_10_referrals: parseInt(document.getElementById('settingBonus10').value),
                        bonus_per_5_extra: parseInt(document.getElementById('settingBonus5').value)
                    }
                };
                
                for (let [key, value] of Object.entries(settings)) {
                    await supabaseClient
                        .from('site_settings')
                        .upsert({ 
                            setting_key: key, 
                            setting_value: value,
                            updated_at: new Date().toISOString()
                        });
                }
                
                await logAdminActivity('update_settings', 'Paramètres du site mis à jour');
                
                showToast('Paramètres enregistrés !', 'success');
                
            } catch (error) {
                console.error('Settings error:', error);
                showToast('Erreur lors de l\'enregistrement', 'error');
            }
            
            hideLoading();
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        async function uploadToCloudinary(file, folder) {
            try {
                // 1. Compression côté client (si c'est une image)
                let fileToSend = file;
                if (file.type.startsWith('image/')) {
                // Compresser : max 1200px de large, qualité 0.8
                fileToSend = await compressImage(file, 1200, 0.8);
                console.log(`Compression: ${(file.size/1024).toFixed(0)}KB -> ${(fileToSend.size/1024).toFixed(0)}KB`);
                }

                // 2. Préparation Upload
                const formData = new FormData();
                formData.append('file', fileToSend);
                formData.append('upload_preset', CONFIG.CLOUDINARY_UPLOAD_PRESET);
                formData.append('folder', `social_vote/${folder}`);

                // 3. Envoi vers Cloudinary
                const response = await fetch(
                `https://api.cloudinary.com/v1_1/${CONFIG.CLOUDINARY_CLOUD_NAME}/auto/upload`,
                { method: 'POST', body: formData }
                );

                if (!response.ok) throw new Error('Erreur upload Cloudinary');

                const data = await response.json();
                
                // 4. Retourne l'URL sécurisée (déjà optimisée par le preset Cloudinary)
                return data.secure_url;
                
            } catch (error) {
                console.error('Erreur upload:', error);
                throw error;
            }
        }
        
        // Fonction pour compresser une image côté client avant upload
            function compressImage(file, maxWidth = 1200, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        // Calcul des nouvelles dimensions
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                        }

                        // Création du canvas
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Conversion en blob (JPEG compressé)
                        canvas.toBlob((blob) => {
                        if (!blob) {
                            reject(new Error('Erreur de compression'));
                            return;
                        }
                        // On renvoie le fichier compressé avec le nom original
                        const compressedFile = new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now(),
                        });
                        resolve(compressedFile);
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = (err) => reject(err);
                    };
                    reader.onerror = (err) => reject(err);
                });
            }

        async function logAdminActivity(actionType, description) {
            try {
                await supabaseClient
                    .from('activity_logs')
                    .insert([{
                        user_id: adminUser?.id,
                        action_type: actionType,
                        description: description,
                        created_at: new Date().toISOString()
                    }]);
            } catch (error) {
                console.error('Log error:', error);
            }
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function showLoading(text = 'Chargement...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }
        
        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'À l\'instant';
            if (seconds < 3600) return `Il y a ${Math.floor(seconds / 60)} min`;
            if (seconds < 86400) return `Il y a ${Math.floor(seconds / 3600)}h`;
            if (seconds < 604800) return `Il y a ${Math.floor(seconds / 86400)}j`;
            return formatDate(dateString);
        }
        

        function escapeHtml(str) {
        return String(str ?? '')
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
        }

        // ===============================
    // SPONSORS + TESTIMONIALS (CREATE)
    // ===============================
    let sponsorLogoFile = null;
    let testimonialPhotoFile = null;

    function openCreateSponsorModal() {
    document.getElementById('createSponsorForm').reset();
    sponsorLogoFile = null;
    document.getElementById('sponsorLogoUpload').classList.remove('has-file');
    document.getElementById('sponsorLogoPreview').style.display = 'none';
    openModal('createSponsorModal');
    }

    function previewSponsorLogo(input) {
    const file = input.files?.[0];
    if (!file) return;
    sponsorLogoFile = file;

    const upload = document.getElementById('sponsorLogoUpload');
    const preview = document.getElementById('sponsorLogoPreview');
    upload.classList.add('has-file');

    const reader = new FileReader();
    reader.onload = (e) => {
        preview.src = e.target.result;
        preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
    }

    async function createSponsor() {
    const name = document.getElementById('sponsorName').value.trim();
    const description = document.getElementById('sponsorDescription').value.trim();
    const website = document.getElementById('sponsorWebsite').value.trim();
    const tier = document.getElementById('sponsorTier').value;
    const displayOrder = parseInt(document.getElementById('sponsorOrder').value || '0', 10);
    const isActive = document.getElementById('sponsorActive').checked;

    if (!name) return showToast('Nom requis', 'error');
    if (!sponsorLogoFile) return showToast('Logo requis', 'error');

    showLoading('Upload logo sponsor...');
    try {
        const logoUrl = await uploadToCloudinary(sponsorLogoFile, 'sponsors');

        showLoading('Création sponsor...');
        const { error } = await supabaseClient
        .from('sponsors')
        .insert([{
            name,
            description,
            website_url: website || null,
            tier: tier || 'bronze',
            is_active: isActive,
            display_order: displayOrder,
            logo_url: logoUrl
        }]);

        if (error) throw error;

        await logAdminActivity('create_sponsor', `Sponsor créé: ${name}`);

        closeModal('createSponsorModal');
        showToast('Sponsor ajouté !', 'success');
        await loadSponsors();
    } catch (e) {
        console.error(e);
        showToast('Erreur création sponsor', 'error');
    } finally {
        hideLoading();
    }
    }

    function openCreateTestimonialModal() {
    document.getElementById('createTestimonialForm').reset();
    testimonialPhotoFile = null;
    document.getElementById('testiPhotoUpload').classList.remove('has-file');
    document.getElementById('testiPhotoPreview').style.display = 'none';
    openModal('createTestimonialModal');
    }

    function previewTestimonialPhoto(input) {
    const file = input.files?.[0];
    if (!file) return;
    testimonialPhotoFile = file;

    const upload = document.getElementById('testiPhotoUpload');
    const preview = document.getElementById('testiPhotoPreview');
    upload.classList.add('has-file');

    const reader = new FileReader();
    reader.onload = (e) => {
        preview.src = e.target.result;
        preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
    }

    async function createTestimonial() {
    const name = document.getElementById('testiName').value.trim();
    const quote = document.getElementById('testiQuote').value.trim();
    const gameTitle = document.getElementById('testiGameTitle').value.trim();
    const rank = parseInt(document.getElementById('testiRank').value || '', 10);
    const isActive = document.getElementById('testiActive').checked;

    if (!name || !quote) return showToast('Nom et témoignage requis', 'error');

    showLoading('Création témoignage...');
    try {
        let photoUrl = null;
        if (testimonialPhotoFile) {
        showLoading('Upload photo...');
        photoUrl = await uploadToCloudinary(testimonialPhotoFile, 'testimonials');
        }

        const { error } = await supabaseClient
        .from('testimonials')
        .insert([{
            name,
            quote,
            photo_url: photoUrl,
            game_title: gameTitle || null,
            rank_achieved: Number.isFinite(rank) ? rank : null,
            is_active: isActive
        }]);

        if (error) throw error;

        await logAdminActivity('create_testimonial', `Témoignage ajouté: ${name}`);

        closeModal('createTestimonialModal');
        showToast('Témoignage ajouté !', 'success');
        await loadTestimonials();
    } catch (e) {
        console.error(e);
        showToast('Erreur création témoignage', 'error');
    } finally {
        hideLoading();
    }
    }

// ===============================
// GAME DETAILS MODAL
// ===============================
async function viewGameDetails(gameId) {
  showLoading('Chargement des détails du jeu...');
  try {
    const { data: game, error: gameErr } = await supabaseClient
      .from('games')
      .select('*')
      .eq('id', gameId)
      .single();
    if (gameErr) throw gameErr;

    const [{ data: prizes }, { data: entries }] = await Promise.all([
      supabaseClient
        .from('game_prizes')
        .select('*')
        .eq('game_id', gameId)
        .order('position', { ascending: true }),

      supabaseClient
        .from('game_entries')
        .select(`
          id, candidate_number, free_votes, paid_votes, referral_bonus_votes, total_votes, status, rank,
          users:user_id(full_name, photo_url)
        `)
        .eq('game_id', gameId)
        .order('total_votes', { ascending: false })
    ]);

    const approved = (entries || []).filter(e => e.status === 'approved');
    const pending = (entries || []).filter(e => e.status === 'pending');
    const rejected = (entries || []).filter(e => e.status === 'rejected');

    const totalVotes = approved.reduce((s, e) => s + (e.total_votes || 0), 0);
    const paidVotesTotal = approved.reduce((s, e) => s + (e.paid_votes || 0), 0);
    const registrationRevenue = approved.length * (Number(game.registration_fee) || 0);
    const paidVotesRevenue = paidVotesTotal * (Number(game.vote_price) || 0);

    const statusBadge = (st) => {
      const map = {
        draft: ['badge-primary', 'Brouillon'],
        pending: ['badge-warning', 'En attente'],
        active: ['badge-success', 'Actif'],
        ended: ['badge-info', 'Terminé'],
        archived: ['badge-primary', 'Archivé']
      };
      const [cls, label] = map[st] || ['badge-primary', st];
      return `<span class="badge ${cls}">${label}</span>`;
    };

    const top = approved.slice(0, Math.min(10, approved.length));

    document.getElementById('gameDetailsBody').innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:15px;flex-wrap:wrap;align-items:center;margin-bottom:15px;">
        <div>
          <h2 style="color:var(--primary);margin-bottom:6px;">${escapeHtml(game.title)}</h2>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            ${statusBadge(game.status)}
            <span class="badge badge-gold"><i class="fas fa-trophy"></i> ${game.winners_count || 3} gagnants</span>
          </div>
        </div>
        <a class="btn btn-outline" href="..//vote/" target="_blank">
          <i class="fas fa-external-link-alt"></i> Ouvrir Vote
        </a>
      </div>

      <div class="card" style="box-shadow:none;border:1px solid #eee;">
        <div class="card-body" style="padding:18px;">
          <p style="color:var(--gray);margin-bottom:10px;">${escapeHtml(game.description || '—')}</p>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
            <div><strong>Début:</strong> ${formatDateTime(game.start_time)}</div>
            <div><strong>Fin:</strong> ${formatDateTime(game.end_time)}</div>
            <div><strong>Inscription:</strong> ${Number(game.registration_fee || 0).toLocaleString()} FCFA</div>
            <div><strong>Prix du vote:</strong> ${Number(game.vote_price || 0).toLocaleString()} FCFA</div>
            <div><strong>Candidats approuvés:</strong> ${approved.length}</div>
            <div><strong>En attente:</strong> ${pending.length}</div>
            <div><strong>Rejetés:</strong> ${rejected.length}</div>
            <div><strong>Total votes:</strong> ${totalVotes.toLocaleString()}</div>
            <div><strong>Revenus inscriptions:</strong> ${registrationRevenue.toLocaleString()} FCFA</div>
            <div><strong>Revenus votes payants (estim.):</strong> ${paidVotesRevenue.toLocaleString()} FCFA</div>
          </div>
        </div>
      </div>

      <h3 style="color:var(--primary);margin:20px 0 10px;"><i class="fas fa-gift" style="color:var(--accent);"></i> Prix</h3>
      ${
        (prizes || []).length === 0
          ? `<div class="alert alert-info"><i class="fas fa-info-circle"></i> Aucun prix enregistré.</div>`
          : `
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;">
              ${(prizes || []).map(p => `
                <div style="background:var(--light-bg);border-radius:12px;padding:12px;display:flex;gap:12px;">
                  <img src="${p.photo_url || ''}" onerror="this.style.display='none'" style="width:70px;height:70px;border-radius:10px;object-fit:cover;border:1px solid #ddd;">
                  <div>
                    <div class="badge badge-gold" style="margin-bottom:6px;">#${p.position}</div>
                    <div style="font-weight:800;color:var(--primary);">${escapeHtml(p.title)}</div>
                    <div style="color:var(--gray);font-size:.9rem;">${escapeHtml(p.description || '')}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          `
      }

      <h3 style="color:var(--primary);margin:20px 0 10px;"><i class="fas fa-list-ol" style="color:var(--accent);"></i> Top candidats</h3>
      ${
        top.length === 0
          ? `<div class="alert alert-info"><i class="fas fa-info-circle"></i> Aucun candidat approuvé pour ce jeu.</div>`
          : `
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Candidat</th>
                    <th>Numéro</th>
                    <th>Gratuits</th>
                    <th>Payants</th>
                    <th>Bonus</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${top.map((e, idx) => `
                    <tr>
                      <td><strong>${idx + 1}</strong></td>
                      <td>
                        <div class="table-user">
                          <img src="${e.users?.photo_url || ''}" onerror="this.src='';this.style.display='none'">
                          <div>
                            <span class="name">${escapeHtml(e.users?.full_name || 'N/A')}</span>
                          </div>
                        </div>
                      </td>
                      <td><code>${escapeHtml(e.candidate_number || '')}</code></td>
                      <td>${e.free_votes || 0}</td>
                      <td>${e.paid_votes || 0}</td>
                      <td>${e.referral_bonus_votes || 0}</td>
                      <td><strong style="color:var(--accent)">${e.total_votes || 0}</strong></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `
      }
    `;

    // Footer actions (archive only when ended)
    const footer = document.getElementById('gameDetailsFooter');
    footer.innerHTML = `
      <button class="btn btn-outline" onclick="closeModal('gameDetailsModal')">Fermer</button>
      ${game.status === 'ended'
        ? `<button class="btn btn-secondary" onclick="archiveGame('${game.id}'); closeModal('gameDetailsModal');">
             <i class="fas fa-archive"></i> Archiver
           </button>`
        : ''
      }
      ${game.status === 'draft' || game.status === 'pending'
        ? `<button class="btn btn-danger" onclick="deleteGame('${game.id}'); closeModal('gameDetailsModal');">
             <i class="fas fa-trash"></i> Supprimer
           </button>`
        : ''
      }
    `;

    openModal('gameDetailsModal');
  } catch (e) {
    console.error(e);
    showToast("Impossible de charger les détails du jeu", "error");
  } finally {
    hideLoading();
  }
}

// small helper to avoid HTML injection in admin UI
function escapeHtml(str) {
  return String(str ?? '')
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

async function viewUserDetails(userId) {
  showLoading('Chargement utilisateur...');
  try {
    const { data: user, error: uErr } = await supabaseClient
      .from('users')
      .select('*')
      .eq('id', userId)
      .single();
    if (uErr) throw uErr;

    const { data: cand } = await supabaseClient
      .from('candidate_profiles')
      .select('*')
      .eq('user_id', userId)
      .maybeSingle();

    let entries = [];
    if (cand?.id) {
      const { data } = await supabaseClient
        .from('game_entries')
        .select('*, games:game_id(title, status, start_time, end_time)')
        .eq('candidate_id', cand.id)
        .order('created_at', { ascending: false });
      entries = data || [];
    }

    const { data: votesCast } = await supabaseClient
      .from('votes')
      .select('vote_type, vote_count, amount_paid, voted_at, games:game_id(title)')
      .eq('voter_id', userId)
      .order('voted_at', { ascending: false })
      .limit(50);

    let referralStats = null;
    if (cand?.id) {
      const { data: refs } = await supabaseClient
        .from('referrals')
        .select('game_id, created_at, games:game_id(title)')
        .eq('referrer_id', cand.id);

      const { data: pays } = await supabaseClient
        .from('referral_payments')
        .select('payment_status, bonus_amount, referral_count, paid_at, games:game_id(title)')
        .eq('referrer_id', cand.id);

      referralStats = { refs: refs || [], pays: pays || [] };
    }

    const totalVoteCount = (votesCast || []).reduce((s, v) => s + (v.vote_count || 1), 0);
    const totalPaidSpent = (votesCast || []).reduce((s, v) => s + (v.amount_paid || 0), 0);

    const body = document.getElementById('userDetailsBody');

    body.innerHTML = `
      <div style="display:flex;gap:18px;align-items:center;flex-wrap:wrap;margin-bottom:15px;">
        <img src="${user.photo_url || ''}" onerror="this.style.display='none'"
          style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--accent);">
        <div>
          <h2 style="color:var(--primary);margin:0;">${escapeHtml(user.full_name)}</h2>
          <div style="color:var(--gray);font-size:.95rem;">
            ${escapeHtml(user.email)} • ${escapeHtml(user.phone || '')}
          </div>
          <div style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;">
            <span class="badge badge-${user.role === 'admin' ? 'danger' : user.role === 'candidate' ? 'success' : 'primary'}">${user.role}</span>
            <span class="badge ${user.is_banned ? 'badge-danger' : 'badge-success'}">${user.is_banned ? 'Banni' : 'Actif'}</span>
          </div>
        </div>
      </div>

      <div class="card" style="box-shadow:none;border:1px solid #eee;">
        <div class="card-body" style="padding:16px;">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;">
            <div><strong>WhatsApp:</strong> ${escapeHtml(user.whatsapp_number || 'N/A')}</div>
            <div><strong>Mobile Money:</strong> ${escapeHtml(user.mobile_money_type || '')} ${escapeHtml(user.mobile_money_number || '')}</div>
            <div><strong>Inscrit le:</strong> ${formatDateTime(user.created_at)}</div>
            <div><strong>Dernière connexion:</strong> ${user.last_login ? formatDateTime(user.last_login) : '—'}</div>
          </div>
        </div>
      </div>

      ${cand ? `
        <h3 style="color:var(--primary);margin:18px 0 10px;"><i class="fas fa-star" style="color:var(--accent)"></i> Profil Candidat</h3>
        <div class="card" style="box-shadow:none;border:1px solid #eee;">
          <div class="card-body" style="padding:16px;">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;">
              <div><strong>Username:</strong> ${escapeHtml(cand.username)}</div>
              <div><strong>Code parrainage:</strong> <code>${escapeHtml(cand.referral_code)}</code></div>
              <div><strong>Votes reçus (cache):</strong> ${cand.total_votes_received || 0}</div>
              <div><strong>Victoires (cache):</strong> ${cand.total_victories || 0}</div>
            </div>
            ${cand.biography ? `<div style="margin-top:10px;color:var(--gray)">${escapeHtml(cand.biography)}</div>` : ''}
          </div>
        </div>

        <h3 style="color:var(--primary);margin:18px 0 10px;"><i class="fas fa-gamepad" style="color:var(--accent)"></i> Participations</h3>
        ${
          entries.length === 0
            ? `<div class="alert alert-info"><i class="fas fa-info-circle"></i> Aucune participation.</div>`
            : `
              <div class="table-container">
                <table class="data-table">
                  <thead><tr><th>Jeu</th><th>Statut</th><th>Votes</th><th>Rang</th><th>Créé</th></tr></thead>
                  <tbody>
                    ${entries.map(e => `
                      <tr>
                        <td>${escapeHtml(e.games?.title || '')}</td>
                        <td><span class="badge badge-${e.games?.status === 'active' ? 'success' : e.games?.status === 'pending' ? 'warning' : 'primary'}">${escapeHtml(e.games?.status || '')}</span></td>
                        <td><strong>${e.total_votes || 0}</strong> (G:${e.free_votes || 0} P:${e.paid_votes || 0} B:${e.referral_bonus_votes || 0})</td>
                        <td>${e.rank || '—'}</td>
                        <td>${formatDate(e.created_at)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `
        }

        <h3 style="color:var(--primary);margin:18px 0 10px;"><i class="fas fa-user-friends" style="color:var(--accent)"></i> Parrainage</h3>
        ${
          referralStats
            ? `
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
                <div class="card" style="box-shadow:none;border:1px solid #eee;">
                  <div class="card-body" style="padding:16px;">
                    <strong>Filleuls total:</strong> ${(referralStats.refs || []).length}
                  </div>
                </div>
                <div class="card" style="box-shadow:none;border:1px solid #eee;">
                  <div class="card-body" style="padding:16px;">
                    <strong>Paiements:</strong> ${(referralStats.pays || []).length}
                    <br><small style="color:var(--gray)">Payés: ${(referralStats.pays || []).filter(p=>p.payment_status==='paid').length} • En attente: ${(referralStats.pays || []).filter(p=>p.payment_status==='pending').length}</small>
                  </div>
                </div>
              </div>

              ${
                (referralStats.pays || []).length ? `
                  <div class="table-container" style="margin-top:10px;">
                    <table class="data-table">
                      <thead><tr><th>Jeu</th><th>Filleuls</th><th>Montant</th><th>Statut</th><th>Payé le</th></tr></thead>
                      <tbody>
                        ${referralStats.pays.map(p => `
                          <tr>
                            <td>${escapeHtml(p.games?.title || '')}</td>
                            <td>${p.referral_count || 0}</td>
                            <td><strong>${Number(p.bonus_amount||0).toLocaleString()} F</strong></td>
                            <td><span class="badge ${p.payment_status==='paid'?'badge-success':'badge-warning'}">${p.payment_status}</span></td>
                            <td>${p.paid_at ? formatDateTime(p.paid_at) : '—'}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                ` : `<div class="alert alert-info" style="margin-top:10px;"><i class="fas fa-info-circle"></i> Aucun paiement enregistré.</div>`
              }
            `
            : `<div class="alert alert-info"><i class="fas fa-info-circle"></i> Aucun profil candidat.</div>`
        }
      ` : ''}
      
      <h3 style="color:var(--primary);margin:18px 0 10px;"><i class="fas fa-vote-yea" style="color:var(--accent)"></i> Votes effectués (50 derniers)</h3>
      ${
        (votesCast || []).length === 0
          ? `<div class="alert alert-info"><i class="fas fa-info-circle"></i> Aucun vote enregistré.</div>`
          : `
            <div style="color:var(--gray);margin-bottom:10px;">
              Total votes: <strong>${totalVoteCount}</strong> • Montant payé: <strong>${totalPaidSpent.toLocaleString()} FCFA</strong>
            </div>
            <div class="table-container">
              <table class="data-table">
                <thead><tr><th>Jeu</th><th>Type</th><th>Votes</th><th>Montant</th><th>Date</th></tr></thead>
                <tbody>
                  ${(votesCast || []).map(v => `
                    <tr>
                      <td>${escapeHtml(v.games?.title || '')}</td>
                      <td><span class="badge ${v.vote_type==='paid'?'badge-info':v.vote_type==='free'?'badge-success':'badge-gold'}">${v.vote_type}</span></td>
                      <td>${v.vote_count || 1}</td>
                      <td>${Number(v.amount_paid||0).toLocaleString()} F</td>
                      <td>${formatDateTime(v.voted_at)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `
      }
    `;

    openModal('userDetailsModal');
  } catch (e) {
    console.error(e);
    showToast("Erreur détails utilisateur", "error");
  } finally {
    hideLoading();
  }
}

        // ===============================
// FINALIZE & ARCHIVE GAME
// ===============================
let __finalizeGame = null;
let __finalizeWinners = [];
let __awardPhotos = {}; // key: position => [File,File,File]

async function openFinalizeGameModal(gameId) {
  showLoading('Chargement finalisation...');
  __finalizeGame = null;
  __finalizeWinners = [];
  __awardPhotos = {};

  try {
    const { data: game, error: gErr } = await supabaseClient
      .from('games')
      .select('*')
      .eq('id', gameId)
      .single();
    if (gErr) throw gErr;

    // Winners: top winners_count approved entries
    const { data: winners, error: wErr } = await supabaseClient
      .from('game_entries')
      .select('id, candidate_number, total_votes, users:user_id(full_name, photo_url)')
      .eq('game_id', gameId)
      .eq('status', 'approved')
      .order('total_votes', { ascending: false })
      .limit(game.winners_count || 3);

    if (wErr) throw wErr;

    // Existing awarded prizes if any
    const { data: awarded } = await supabaseClient
      .from('game_awarded_prizes')
      .select('*')
      .eq('game_id', gameId)
      .order('position', { ascending: true });

    const awardedMap = new Map((awarded || []).map(a => [a.position, a]));

    __finalizeGame = game;
    __finalizeWinners = winners || [];

    // UI header
    document.getElementById('finalizeGameInfo').innerHTML = `
      <i class="fas fa-info-circle"></i>
      <strong>${escapeHtml(game.title)}</strong> — Terminé.
      <br>Veuillez renseigner les <strong>prix réellement remis</strong> (photos 1 à 3) pour chaque gagnant.
    `;

    // Build editor
    const editor = document.getElementById('finalizeAwardsEditor');
    editor.innerHTML = `
      <div style="display:grid;gap:18px;">
        ${__finalizeWinners.map((w, idx) => {
          const pos = idx + 1;
          const existing = awardedMap.get(pos);
          const defaultTitle = existing?.title || `Prix du ${pos}${pos===1?'er':'ème'} gagnant`;
          const defaultDesc = existing?.description || '';
          const existingPhotos = Array.isArray(existing?.photos) ? existing.photos : (existing?.photos || []);

          return `
            <div class="card" style="box-shadow:none;border:1px solid #eee;">
              <div class="card-header">
                <h3><i class="fas fa-trophy"></i> ${pos}${pos===1?'er':'ème'} gagnant</h3>
                <span class="badge badge-gold">${escapeHtml(w.users?.full_name || '')} • ${w.total_votes || 0} votes</span>
              </div>
              <div class="card-body">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                  <div>
                    <div class="form-group">
                      <label>Titre du prix réel <span class="required">*</span></label>
                      <input class="form-control" id="awardTitle_${pos}" value="${escapeHtml(defaultTitle)}">
                    </div>
                    <div class="form-group">
                      <label>Description</label>
                      <input class="form-control" id="awardDesc_${pos}" value="${escapeHtml(defaultDesc)}">
                    </div>
                    <div style="color:var(--gray);font-size:.85rem;">
                      Winner entry: <code>${w.id}</code>
                    </div>
                  </div>

                  <div>
                    <label>Photos du prix (1 à 3)</label>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                      ${[1,2,3].map(n => `
                        <div style="width:120px;height:90px;border:2px dashed #ccc;border-radius:10px;position:relative;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center;">
                          <img id="awardPreview_${pos}_${n}" src="${existingPhotos?.[n-1] || ''}" onerror="this.style.display='none'" style="width:100%;height:100%;object-fit:cover;${existingPhotos?.[n-1] ? '' : 'display:none'}">
                          <i id="awardIcon_${pos}_${n}" class="fas fa-camera" style="color:#888;${existingPhotos?.[n-1] ? 'display:none' : ''}"></i>
                          <input type="file" accept="image/*"
                            style="position:absolute;inset:0;opacity:0;cursor:pointer;"
                            onchange="handleAwardPhoto(${pos}, ${n}, this)">
                        </div>
                      `).join('')}
                    </div>
                    <div style="margin-top:8px;color:var(--gray);font-size:.85rem;">
                      Si aucune nouvelle photo n'est ajoutée, on conserve celles déjà enregistrées (si existantes).
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;

    openModal('finalizeGameModal');
  } catch (e) {
    console.error(e);
    showToast("Erreur chargement finalisation", "error");
  } finally {
    hideLoading();
  }
}

function handleAwardPhoto(position, slot, input) {
  const file = input.files?.[0];
  if (!file) return;

  __awardPhotos[position] = __awardPhotos[position] || {};
  __awardPhotos[position][slot] = file;

  const reader = new FileReader();
  reader.onload = (e) => {
    const img = document.getElementById(`awardPreview_${position}_${slot}`);
    const icon = document.getElementById(`awardIcon_${position}_${slot}`);
    img.src = e.target.result;
    img.style.display = 'block';
    icon.style.display = 'none';
  };
  reader.readAsDataURL(file);
}

// ============================================
// SAVE AWARDS & ARCHIVE (RPC SECURE)
// ============================================
async function saveAwardsAndArchive() {
  if (!__finalizeGame) return;

  const gameId = __finalizeGame.id;

  showLoading('Enregistrement des prix réels...');

  try {
    // 1) Préparer le tableau des awards
    // On charge les existants pour conserver les photos si non modifiées
    const { data: existingAwarded } = await supabaseClient
      .from('game_awarded_prizes')
      .select('*')
      .eq('game_id', gameId);

    const existingMap = new Map((existingAwarded || []).map(a => [a.position, a]));
    const awards = [];

    for (let idx = 0; idx < __finalizeWinners.length; idx++) {
      const pos = idx + 1;
      const winner = __finalizeWinners[idx];

      const title = document.getElementById(`awardTitle_${pos}`).value.trim();
      const description = document.getElementById(`awardDesc_${pos}`).value.trim();

      if (!title) throw new Error(`Titre du prix requis pour position ${pos}`);

      // Gérer les photos (mix existant + upload)
      const existing = existingMap.get(pos);
      const existingPhotos = Array.isArray(existing?.photos) ? existing.photos : (existing?.photos || []);
      const newPhotos = [...existingPhotos];

      // Upload new files (slots 1..3)
      for (const slot of [1, 2, 3]) {
        const file = __awardPhotos?.[pos]?.[slot];
        if (file) {
          const url = await uploadToCloudinary(file, 'awarded_prizes');
          newPhotos[slot - 1] = url;
        }
      }

      // Nettoyer le tableau (garder max 3 non vides)
      const photos = newPhotos.filter(Boolean).slice(0, 3);

      awards.push({
        position: pos,
        title: title,
        description: description || null,
        photos: photos,
        winner_entry_id: winner.id
      });
    }

    // 2) Appel RPC unique (Upsert awards + Archive game)
    const { error: rpcErr } = await supabaseClient.rpc('admin_archive_game', {
      p_admin_id: adminUser.id,
      p_game_id: gameId,
      p_awards: awards
    });

    if (rpcErr) throw rpcErr;

    await logAdminActivity('finalize_archive', `Jeu finalisé & archivé (RPC): ${__finalizeGame.title}`);

    closeModal('finalizeGameModal');
    showToast('Jeu archivé avec prix réels !', 'success');

    // Refresh UI
    await loadGames();
    await loadCurrentGameStatus();

  } catch (e) {
    console.error(e);
    showToast(e.message || "Erreur enregistrement", "error");
  } finally {
    hideLoading();
  }
}


        // Initialize prizes editor on load
        updatePrizesEditor();


        async function loadAdStats() {
    
    // 1. Récupérer TOUS les événements (Attention à la performance si > 10k lignes, faudra paginer ou RPC)
    const { data: events, error } = await supabaseClient
        .from('ad_events')
        .select('ad_id, event_type, event_value, created_at');

    if (error) { console.error("Erreur stats pubs:", error); return; }
    console.log("Events reçus:", events); // <--- AJOUTE ÇA
    // 2. Calculer les totaux
    let views = 0, clicks = 0, time = 0;
    const statsByAd = {}; // Map: ad_id => { views, clicks, time }

    events.forEach(e => {
        if (!statsByAd[e.ad_id]) statsByAd[e.ad_id] = { views: 0, clicks: 0, time: 0 };
        
        if (e.event_type === 'view') {
            views++;
            statsByAd[e.ad_id].views++;
        } else if (e.event_type === 'click') {
            clicks++;
            statsByAd[e.ad_id].clicks++;
        } else if (e.event_type === 'watch_time') {
            time += (e.event_value || 0);
            statsByAd[e.ad_id].time += (e.event_value || 0);
        }
    });

    // 3. Afficher les globaux
    document.getElementById('totalAdViews').textContent = views.toLocaleString();
    document.getElementById('totalAdClicks').textContent = clicks.toLocaleString();
    document.getElementById('avgAdCTR').textContent = views > 0 ? ((clicks / views) * 100).toFixed(2) + '%' : '0%';
    document.getElementById('totalAdTime').textContent = Math.round(time / 60) + ' min'; // ou format h:m:s

    // 4. Générer le Graphique (Vues vs Clics sur 7 jours)
    renderAdsChart(events);

    // 5. Stocker les stats par pub pour l'affichage liste (étape suivante)
    window.adStatsCache = statsByAd;
    console.log("Chargement des stats pubs..."); // <--- AJOUTE ÇA
}

function renderAdsChart(events) {
    const ctx = document.getElementById('adsChart').getContext('2d');
    
    // Grouper par date (YYYY-MM-DD)
    const days = {};
    const today = new Date();
    for(let i=6; i>=0; i--) { // 7 derniers jours
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        days[d.toISOString().slice(0,10)] = { views: 0, clicks: 0 };
    }

    events.forEach(e => {
        const date = e.created_at.slice(0,10);
        if (days[date]) {
            if (e.event_type === 'view') days[date].views++;
            if (e.event_type === 'click') days[date].clicks++;
        }
    });

    const labels = Object.keys(days);
    const dataViews = labels.map(d => days[d].views);
    const dataClicks = labels.map(d => days[d].clicks);

    if (window.adsChartInstance) window.adsChartInstance.destroy();

    window.adsChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'Vues', data: dataViews, borderColor: '#0A1F44', tension: 0.4 },
                { label: 'Clics', data: dataClicks, borderColor: '#D4AF37', tension: 0.4 }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

// Observer les clics sur le menu pour déclencher le chargement
document.querySelectorAll('.menu-item[data-section="ads"]').forEach(btn => {
    btn.addEventListener('click', () => {
        console.log("Menu Pubs cliqué !");
        loadAdStats();
        loadAds();
    });
});
    </script>
</body>
</html>